---
# Deploy Scaleway Serverless Function for idle Mac mini deletion
# OPTIONAL: Only deploys if DEPLOY_SCALEWAY_IDLE_FUNCTION=true in .env
# Creates function + CRON trigger to run every hour

- name: Deploy Scaleway idle checker function
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Setup .env
      ansible.builtin.include_tasks:
        file: ../../common/setup_env.yml

    - name: Check if deployment is enabled
      ansible.builtin.fail:
        msg: |
          Serverless function deployment is DISABLED.
          To enable: Set DEPLOY_SCALEWAY_IDLE_FUNCTION=true in ansible/tests/.env

          This is a one-time setup that creates:
          - Scaleway Functions namespace
          - Python function for idle detection
          - Hourly CRON trigger

          Cost: ~$0.40/month for 720 hourly executions
      when: not (env.DEPLOY_SCALEWAY_IDLE_FUNCTION | default('false') | bool)

    - name: Check if function namespace exists using scw CLI
      ansible.builtin.shell: |
        export SCW_ACCESS_KEY="{{ env.SCALEWAY_ACCESS_KEY_ID }}"
        export SCW_SECRET_KEY="{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        export SCW_DEFAULT_PROJECT_ID="{{ env.SCALEWAY_PROJECT_ID }}"
        export SCW_DEFAULT_REGION="{{ env.SCALEWAY_REGION }}"
        scw function namespace list region={{ env.SCALEWAY_REGION }} -o json | jq -r '.[] | select(.name == "dfe-test-automation") | .id'
      register: namespace_check
      changed_when: false
      failed_when: false

    - name: Create function namespace if not exists using scw CLI
      ansible.builtin.shell: |
        export SCW_ACCESS_KEY="{{ env.SCALEWAY_ACCESS_KEY_ID }}"
        export SCW_SECRET_KEY="{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        export SCW_DEFAULT_PROJECT_ID="{{ env.SCALEWAY_PROJECT_ID }}"
        export SCW_DEFAULT_REGION="{{ env.SCALEWAY_REGION }}"
        scw function namespace create \
          name=dfe-test-automation \
          project-id="{{ env.SCALEWAY_PROJECT_ID }}" \
          description="DFE test infrastructure automation" \
          region={{ env.SCALEWAY_REGION }} \
          -o json | jq -r '.id'
      register: namespace_create
      when: namespace_check.stdout | length == 0
      changed_when: true

    - name: Set namespace ID
      ansible.builtin.set_fact:
        namespace_id: "{{ namespace_check.stdout if namespace_check.stdout | length > 0 else namespace_create.stdout }}"

    - name: Check if function exists using scw CLI
      ansible.builtin.shell: |
        export SCW_ACCESS_KEY="{{ env.SCALEWAY_ACCESS_KEY_ID }}"
        export SCW_SECRET_KEY="{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        export SCW_DEFAULT_PROJECT_ID="{{ env.SCALEWAY_PROJECT_ID }}"
        export SCW_DEFAULT_REGION="{{ env.SCALEWAY_REGION }}"
        scw function function list namespace-id={{ namespace_id }} region={{ env.SCALEWAY_REGION }} -o json | jq -r '.[] | select(.name == "mac-idle-checker") | .id'
      register: function_check
      changed_when: false
      failed_when: false

    - name: Create function for idle checking using scw CLI
      ansible.builtin.shell: |
        export SCW_ACCESS_KEY="{{ env.SCALEWAY_ACCESS_KEY_ID }}"
        export SCW_SECRET_KEY="{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        export SCW_DEFAULT_PROJECT_ID="{{ env.SCALEWAY_PROJECT_ID }}"
        export SCW_DEFAULT_REGION="{{ env.SCALEWAY_REGION }}"
        scw function function create \
          name=mac-idle-checker \
          namespace-id={{ namespace_id }} \
          runtime=python311 \
          handler=idle_checker.handle \
          min-scale=0 \
          max-scale=1 \
          memory-limit=256 \
          timeout=60s \
          region={{ env.SCALEWAY_REGION }} \
          -o json | jq -r '.id'
      register: function_create
      when: function_check.stdout | length == 0
      changed_when: true

    - name: Set function ID
      ansible.builtin.set_fact:
        function_id: "{{ function_check.stdout if function_check.stdout | length > 0 else function_create.stdout }}"

    - name: Upload function code (always update)
      ansible.builtin.shell: |
        cd {{ playbook_dir }}
        zip -r /tmp/idle_checker.zip idle_checker.py
        export SCW_ACCESS_KEY="{{ env.SCALEWAY_ACCESS_KEY_ID }}"
        export SCW_SECRET_KEY="{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        export SCW_DEFAULT_PROJECT_ID="{{ env.SCALEWAY_PROJECT_ID }}"
        export SCW_DEFAULT_REGION="{{ env.SCALEWAY_REGION }}"
        curl -X POST \
          -H "X-Auth-Token: {{ env.SCALEWAY_ACCESS_KEY_SECRET }}" \
          -F "file=@/tmp/idle_checker.zip" \
          "https://api.scaleway.com/functions/v1beta1/regions/{{ env.SCALEWAY_REGION }}/functions/{{ function_id }}/upload"
      changed_when: true

    - name: Check if CRON trigger exists using scw CLI
      ansible.builtin.shell: |
        export SCW_ACCESS_KEY="{{ env.SCALEWAY_ACCESS_KEY_ID }}"
        export SCW_SECRET_KEY="{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        export SCW_DEFAULT_PROJECT_ID="{{ env.SCALEWAY_PROJECT_ID }}"
        export SCW_DEFAULT_REGION="{{ env.SCALEWAY_REGION }}"
        scw function trigger list function-id={{ function_id }} region={{ env.SCALEWAY_REGION }} -o json | jq -r '.[] | select(.name == "idle-check-hourly") | .id'
      register: trigger_check
      changed_when: false
      failed_when: false

    - name: Create CRON trigger if not exists (runs every hour)
      ansible.builtin.shell: |
        export SCW_ACCESS_KEY="{{ env.SCALEWAY_ACCESS_KEY_ID }}"
        export SCW_SECRET_KEY="{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        export SCW_DEFAULT_PROJECT_ID="{{ env.SCALEWAY_PROJECT_ID }}"
        export SCW_DEFAULT_REGION="{{ env.SCALEWAY_REGION }}"
        scw function trigger create \
          name=idle-check-hourly \
          function-id={{ function_id }} \
          region={{ env.SCALEWAY_REGION }} \
          -o json
      when: trigger_check.stdout | length == 0
      changed_when: true

    - name: Display deployment info
      ansible.builtin.debug:
        msg: |
          âœ… Scaleway Serverless Function Deployed:
          - Function: mac-idle-checker
          - Trigger: Every hour (CRON)
          - Action: Delete Mac minis with 'auto-delete' tag idle >24h
          - Checks: CPU usage, network activity
          - Tags watched: {{ env.SCALEWAY_TAGS }}
          - Future: {{ env.SCALEWAY_AGENT_TAG }}

          Your Mac minis will now auto-delete after 24h of inactivity!
