---
# Deploy Scaleway Serverless Function for idle Mac mini deletion
# OPTIONAL: Only deploys if DEPLOY_SCALEWAY_IDLE_FUNCTION=true in .env
# Creates function + CRON trigger to run every hour

- name: Deploy Scaleway idle checker function
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Setup .env
      ansible.builtin.include_tasks:
        file: ../../common/setup_env.yml

    - name: Check if deployment is enabled
      ansible.builtin.fail:
        msg: |
          Serverless function deployment is DISABLED.
          To enable: Set DEPLOY_SCALEWAY_IDLE_FUNCTION=true in ansible/tests/.env

          This is a one-time setup that creates:
          - Scaleway Functions namespace
          - Python function for idle detection
          - Hourly CRON trigger

          Cost: ~$0.40/month for 720 hourly executions
      when: not (env.DEPLOY_SCALEWAY_IDLE_FUNCTION | default('false') | bool)

    - name: Check if function namespace exists
      ansible.builtin.uri:
        url: "https://api.scaleway.com/functions/v1beta1/regions/{{ env.SCALEWAY_REGION }}/namespaces"
        method: GET
        headers:
          X-Auth-Token: "{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        return_content: true
      register: namespaces

    - name: Find existing namespace
      ansible.builtin.set_fact:
        namespace_id: "{{ item.id }}"
      loop: "{{ namespaces.json.namespaces }}"
      when: item.name == 'dfe-test-automation'
      no_log: true

    - name: Create function namespace if not exists
      ansible.builtin.uri:
        url: "https://api.scaleway.com/functions/v1beta1/regions/{{ env.SCALEWAY_REGION }}/namespaces"
        method: POST
        headers:
          X-Auth-Token: "{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
          Content-Type: application/json
        body_format: json
        body:
          name: dfe-test-automation
          project_id: "{{ env.SCALEWAY_PROJECT_ID }}"
          description: "DFE test infrastructure automation"
        return_content: true
      register: namespace
      when: namespace_id is not defined

    - name: Set namespace ID from new namespace
      ansible.builtin.set_fact:
        namespace_id: "{{ namespace.json.id }}"
      when: namespace is defined and namespace.json is defined

    - name: Get existing functions in namespace
      ansible.builtin.uri:
        url: "https://api.scaleway.com/functions/v1beta1/regions/{{ env.SCALEWAY_REGION }}/functions?namespace_id={{ namespace_id }}"
        method: GET
        headers:
          X-Auth-Token: "{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        return_content: true
      register: functions

    - name: Find existing function
      ansible.builtin.set_fact:
        function_id: "{{ item.id }}"
      loop: "{{ functions.json.functions }}"
      when: item.name == 'mac-idle-checker'
      no_log: true

    - name: Create function for idle checking if not exists
      ansible.builtin.uri:
        url: "https://api.scaleway.com/functions/v1beta1/regions/{{ env.SCALEWAY_REGION }}/functions"
        method: POST
        headers:
          X-Auth-Token: "{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
          Content-Type: application/json
        body_format: json
        body:
          namespace_id: "{{ namespace_id }}"
          name: mac-idle-checker
          runtime: python311
          handler: idle_checker.handle
          min_scale: 0
          max_scale: 1
          memory_limit: 256
          timeout: 60s
          environment_variables:
            SCALEWAY_SECRET_KEY: "{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
            SCALEWAY_ZONE: "{{ env.SCALEWAY_ZONE }}"
        return_content: true
      register: function
      when: function_id is not defined

    - name: Set function ID from new function
      ansible.builtin.set_fact:
        function_id: "{{ function.json.id }}"
      when: function is defined and function.json is defined

    - name: Upload function code (always update)
      ansible.builtin.shell: |
        cd {{ playbook_dir }} && \
        zip -r /tmp/idle_checker.zip idle_checker.py && \
        curl -X POST \
          -H "X-Auth-Token: {{ env.SCALEWAY_ACCESS_KEY_SECRET }}" \
          -F "file=@/tmp/idle_checker.zip" \
          "https://api.scaleway.com/functions/v1beta1/regions/{{ env.SCALEWAY_REGION }}/functions/{{ function_id }}/upload"
      changed_when: true

    - name: Get existing CRON triggers for function
      ansible.builtin.uri:
        url: "https://api.scaleway.com/functions/v1beta1/regions/{{ env.SCALEWAY_REGION }}/crons?function_id={{ function_id }}"
        method: GET
        headers:
          X-Auth-Token: "{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        return_content: true
      register: crons

    - name: Find existing CRON trigger
      ansible.builtin.set_fact:
        cron_id: "{{ item.id }}"
      loop: "{{ crons.json.crons }}"
      when: item.name == 'idle-check-hourly'
      no_log: true

    - name: Create CRON trigger if not exists (runs every hour)
      ansible.builtin.uri:
        url: "https://api.scaleway.com/functions/v1beta1/regions/{{ env.SCALEWAY_REGION }}/crons"
        method: POST
        headers:
          X-Auth-Token: "{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
          Content-Type: application/json
        body_format: json
        body:
          name: idle-check-hourly
          function_id: "{{ function_id }}"
          schedule: "0 * * * *"
          args: {}
        return_content: true
      when: cron_id is not defined

    - name: Display deployment info
      ansible.builtin.debug:
        msg: |
          âœ… Scaleway Serverless Function Deployed:
          - Function: mac-idle-checker ({{ 'existing' if function is not defined else 'created' }})
          - CRON: Every hour ({{ 'existing' if cron_id is defined else 'created' }})
          - Action: Delete Mac minis with 'auto-delete' tag idle >24h
          - Checks: CPU usage, network activity
          - Tags watched: {{ env.SCALEWAY_TAGS }}
          - Future: {{ env.SCALEWAY_AGENT_TAG }}

          Your Mac minis will now auto-delete after 24h of inactivity!
