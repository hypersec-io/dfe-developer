---
# Provision Scaleway Mac mini for testing
# Reads configuration from ../.env file
# Requires: ansible-galaxy collection install scaleway.scaleway

- name: Provision Scaleway Mac mini
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Setup .env
      ansible.builtin.include_tasks:
        file: ../common/setup_env.yml

    - name: Check for existing Mac mini using scw CLI
      ansible.builtin.shell: |
        export SCW_ACCESS_KEY="{{ env.SCALEWAY_ACCESS_KEY_ID }}"
        export SCW_SECRET_KEY="{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        export SCW_DEFAULT_PROJECT_ID="{{ env.SCALEWAY_PROJECT_ID }}"
        export SCW_DEFAULT_ZONE="{{ env.SCALEWAY_ZONE }}"
        scw apple-silicon server list zone={{ env.SCALEWAY_ZONE }} -o json | jq -r '.[] | select(.name == "{{ env.SCALEWAY_MAC_NAME }}") | .id'
      register: existing_server_check
      changed_when: false
      failed_when: false

    - name: Set server_id if Mac mini exists
      ansible.builtin.set_fact:
        server_id: "{{ existing_server_check.stdout }}"
      when: existing_server_check.stdout | length > 0

    - name: Display existing server message
      ansible.builtin.debug:
        msg: "Found existing Mac mini: {{ env.SCALEWAY_MAC_NAME }} (ID: {{ server_id }})"
      when: server_id is defined

    - name: Create Mac mini if not exists using scw CLI
      ansible.builtin.shell: |
        export SCW_ACCESS_KEY="{{ env.SCALEWAY_ACCESS_KEY_ID }}"
        export SCW_SECRET_KEY="{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        export SCW_DEFAULT_PROJECT_ID="{{ env.SCALEWAY_PROJECT_ID }}"
        export SCW_DEFAULT_ZONE="{{ env.SCALEWAY_ZONE }}"
        scw apple-silicon server create \
          name="{{ env.SCALEWAY_MAC_NAME }}" \
          type="{{ env.SCALEWAY_MAC_TYPE }}" \
          project-id="{{ env.SCALEWAY_PROJECT_ID }}" \
          zone="{{ env.SCALEWAY_ZONE }}" \
          -o json | jq -r '.id'
      register: new_server_result
      when: server_id is not defined
      changed_when: true

    - name: Set server ID from new server
      ansible.builtin.set_fact:
        server_id: "{{ new_server_result.stdout }}"
      when: new_server_result is defined and new_server_result.stdout is defined and new_server_result.stdout | length > 0

    - name: Wait for Mac mini to be ready using scw CLI
      ansible.builtin.shell: |
        export SCW_ACCESS_KEY="{{ env.SCALEWAY_ACCESS_KEY_ID }}"
        export SCW_SECRET_KEY="{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        export SCW_DEFAULT_PROJECT_ID="{{ env.SCALEWAY_PROJECT_ID }}"
        export SCW_DEFAULT_ZONE="{{ env.SCALEWAY_ZONE }}"
        scw apple-silicon server get {{ server_id }} zone={{ env.SCALEWAY_ZONE }} -o json
      register: server_info_raw
      until: (server_info_raw.stdout | from_json).status == "ready"
      retries: 60
      delay: 20
      changed_when: false

    - name: Parse server info
      ansible.builtin.set_fact:
        server_info: "{{ server_info_raw.stdout | from_json }}"

    - name: Generate dynamic inventory
      ansible.builtin.copy:
        content: |
          [scaleway_mac]
          {{ server_info.ip }} ansible_user={{ server_info.username }} ansible_password={{ server_info.password }}
        dest: "{{ playbook_dir }}/inventory_scaleway.yml"

    - name: Display connection info
      ansible.builtin.debug:
        msg: |
          âœ… Scaleway Mac mini ready:
          - Name: {{ env.SCALEWAY_MAC_NAME }}
          - SSH: ssh {{ server_info.username }}@{{ server_info.ip }}
          - Password: {{ server_info.password }}
          - VNC: {{ server_info.ip }}:{{ server_info.vnc_port }}
          - Server ID: {{ server_id }}
          - Status: {{ server_info.status }}

          Inventory: {{ playbook_dir }}/inventory_scaleway.yml

          Next: ansible-playbook -i tests/mac/inventory_scaleway.yml playbooks/main.yml
