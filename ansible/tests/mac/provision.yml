---
# Provision Scaleway Mac mini for testing
# Reads configuration from ../.env file
# Requires: ansible-galaxy collection install scaleway.scaleway

- name: Provision Scaleway Mac mini
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Setup .env
      ansible.builtin.include_tasks:
        file: ../common/setup_env.yml

    - name: Check for existing Mac mini
      ansible.builtin.uri:
        url: "https://api.scaleway.com/apple-silicon/v1alpha1/zones/{{ env.SCALEWAY_ZONE }}/servers"
        method: GET
        headers:
          X-Auth-Token: "{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        return_content: true
      register: existing_servers

    - name: Find our Mac mini if it exists
      ansible.builtin.set_fact:
        server_id: "{{ item.id }}"
      loop: "{{ existing_servers.json.servers }}"
      when: item.name == env.SCALEWAY_MAC_NAME
      no_log: true

    - name: Create Mac mini if not exists
      ansible.builtin.uri:
        url: "https://api.scaleway.com/apple-silicon/v1alpha1/zones/{{ env.SCALEWAY_ZONE }}/servers"
        method: POST
        headers:
          X-Auth-Token: "{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
          Content-Type: application/json
        body_format: json
        body:
          name: "{{ env.SCALEWAY_MAC_NAME }}"
          project_id: "{{ env.SCALEWAY_PROJECT_ID }}"
          type: "{{ env.SCALEWAY_MAC_TYPE }}"
        return_content: true
      register: new_server
      when: server_id is not defined

    - name: Set server ID from new server
      ansible.builtin.set_fact:
        server_id: "{{ new_server.json.server.id }}"
      when: new_server is defined and new_server.json is defined

    - name: Wait for Mac mini to be ready
      ansible.builtin.uri:
        url: "https://api.scaleway.com/apple-silicon/v1alpha1/zones/{{ env.SCALEWAY_ZONE }}/servers/{{ server_id }}"
        method: GET
        headers:
          X-Auth-Token: "{{ env.SCALEWAY_ACCESS_KEY_SECRET }}"
        return_content: true
      register: server_info_response
      until: (server_info_response.json.server.status if server_info_response.json.server is defined else server_info_response.json.status) == "ready"
      retries: 60
      delay: 20

    - name: Extract server info (handle both API response formats)
      ansible.builtin.set_fact:
        server_data: "{{ server_info_response.json.server if server_info_response.json.server is defined else server_info_response.json }}"

    - name: Generate dynamic inventory
      ansible.builtin.copy:
        content: |
          [scaleway_mac]
          {{ server_data.ip }} ansible_user={{ server_data.ssh_username }} ansible_password={{ server_data.sudo_password }}
        dest: "{{ playbook_dir }}/inventory_scaleway.yml"

    - name: Display connection info
      ansible.builtin.debug:
        msg: |
          âœ… Scaleway Mac mini ready:
          - Name: {{ env.SCALEWAY_MAC_NAME }}
          - SSH: ssh {{ server_data.ssh_username }}@{{ server_data.ip }}
          - Password: {{ server_data.sudo_password }}
          - VNC: {{ server_data.ip }}:{{ server_data.vnc_port }}
          - Server ID: {{ server_id }}
          - Status: {{ server_data.status }}

          Inventory: {{ playbook_dir }}/inventory_scaleway.yml

          Next: ansible-playbook -i tests/mac/inventory_scaleway.yml playbooks/main.yml

          Auto-delete: 23h idle (managed by serverless function)
