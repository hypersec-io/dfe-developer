---
# CRUD operations for .env file
# Creates .env from .env.sample if missing, updates variables, reads existing

- name: Determine tests directory based on current location
  ansible.builtin.set_fact:
    tests_dir: "{{ playbook_dir | regex_replace('/[^/]+/[^/]+$', '') }}"
  when: "'serverless' in playbook_dir"

- name: Determine tests directory (from mac or proxmox)
  ansible.builtin.set_fact:
    tests_dir: "{{ playbook_dir | regex_replace('/[^/]+$', '') }}"
  when: ("'mac' in playbook_dir or 'proxmox' in playbook_dir") and tests_dir is not defined

- name: Determine tests directory (default)
  ansible.builtin.set_fact:
    tests_dir: "{{ playbook_dir }}"
  when: tests_dir is not defined

- name: Check if .env exists
  ansible.builtin.stat:
    path: "{{ tests_dir }}/.env"
  register: env_file_stat

- name: Create .env from .env.sample if missing
  ansible.builtin.copy:
    src: "{{ tests_dir }}/.env.sample"
    dest: "{{ tests_dir }}/.env"
    mode: '0600'
  when: not env_file_stat.stat.exists

- name: Prompt for missing Proxmox credentials if .env was just created
  ansible.builtin.pause:
    prompt: |
      .env file created from template!
      Please edit ansible/tests/.env with your credentials:
      - Proxmox: PROXMOX_HOST, PROXMOX_USER, PROXMOX_PASSWORD
      - Scaleway: SCALEWAY_ACCESS_KEY_ID, SCALEWAY_ACCESS_KEY_SECRET

      Press Enter when done editing...
  when: not env_file_stat.stat.exists

- name: Load environment variables from .env (shell format)
  ansible.builtin.shell: |
    set -a
    source "{{ tests_dir }}/.env"
    set +a
    env | grep -E '^(SCALEWAY|PROXMOX|DEPLOY|ANSIBLE)_' | jq -R 'split("=") | {(.[0]): .[1:] | join("=")}' | jq -s 'add'
  register: env_raw
  changed_when: false

- name: Parse environment variables into Ansible facts
  ansible.builtin.set_fact:
    env: "{{ env_raw.stdout | from_json }}"

- name: Update .env with runtime values (e.g., generated server IDs)
  ansible.builtin.lineinfile:
    path: "{{ tests_dir }}/.env"
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
    create: false
  loop: "{{ env_updates | default([]) }}"
  when: env_updates is defined
