---
# DFE Developer Environment - Main Playbook
# Installs and configures complete development environment
#
# Usage:
#   ansible-playbook playbooks/main.yml
#   ansible-playbook playbooks/main.yml --check         # Dry-run
#   ansible-playbook playbooks/main.yml --tags docker   # Specific tags

- name: DFE Developer Environment Setup
  hosts: all
  become: false
  gather_facts: true

  pre_tasks:
    - name: Display system information
      ansible.builtin.debug:
        msg: |
          OS: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}
          Architecture: {{ ansible_facts['architecture'] }}
          Python: {{ ansible_facts['python_version'] }}
      tags: ['always']

    # Wait for package manager locks (handles automatic updates in progress)
    - name: Wait for APT lock to be released (Ubuntu)
      ansible.builtin.shell: |
        while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do
          echo "Waiting for APT lock..."
          sleep 5
        done
        echo "APT lock released"
      args:
        executable: /bin/bash
      register: apt_lock_wait
      changed_when: false
      when: ansible_facts['distribution'] == 'Ubuntu'
      retries: 30
      delay: 10
      until: apt_lock_wait.rc == 0
      tags: ['always']

    - name: Wait for DNF lock to be released (Fedora)
      ansible.builtin.shell: |
        while pgrep -x dnf >/dev/null 2>&1 || [ -f /var/run/dnf.pid ]; do
          echo "Waiting for DNF lock..."
          sleep 5
        done
        echo "DNF lock released"
      args:
        executable: /bin/bash
      register: dnf_lock_wait
      changed_when: false
      when: ansible_facts['distribution'] == 'Fedora'
      retries: 30
      delay: 10
      until: dnf_lock_wait.rc == 0
      tags: ['always']

    # Stop automatic updates during playbook to prevent lock conflicts
    - name: Stop unattended-upgrades service (Ubuntu)
      ansible.builtin.systemd:
        name: unattended-upgrades
        state: stopped
      when: ansible_facts['distribution'] == 'Ubuntu'
      become: true
      failed_when: false
      tags: ['always']

    - name: Stop apt-daily services (Ubuntu)
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
      loop:
        - apt-daily.service
        - apt-daily-upgrade.service
        - apt-daily.timer
        - apt-daily-upgrade.timer
      when: ansible_facts['distribution'] == 'Ubuntu'
      become: true
      failed_when: false
      tags: ['always']

    - name: Stop dnf-automatic timer (Fedora)
      ansible.builtin.systemd:
        name: dnf-automatic.timer
        state: stopped
      when: ansible_facts['distribution'] == 'Fedora'
      become: true
      failed_when: false
      tags: ['always']

    - name: Validate supported operating system
      ansible.builtin.fail:
        msg: "Unsupported OS: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}. Supported: Fedora 42+, Ubuntu 24.04+, macOS"
      when: >
        (ansible_facts['distribution'] not in ['Fedora', 'Ubuntu', 'MacOSX']) or
        (ansible_facts['distribution'] == 'Fedora' and ansible_facts['distribution_major_version']|int < 42) or
        (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_version'] is version('24.04', '<'))
      tags: ['always']

    - name: Detect actual user (for sudo operations)
      ansible.builtin.set_fact:
        dfe_actual_user: "{{ ansible_facts['env'].SUDO_USER | default(ansible_facts['user_id'], true) }}"
      tags: ['always']

    - name: Set actual user home directory (Linux)
      ansible.builtin.set_fact:
        dfe_user_home: "{{ '/home/' + dfe_actual_user if dfe_actual_user != 'root' else '/root' }}"
      when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
      tags: ['always']

    - name: Set actual user home directory (macOS)
      ansible.builtin.set_fact:
        dfe_user_home: "{{ '/Users/' + dfe_actual_user }}"
      when: ansible_facts['distribution'] == 'MacOSX'
      tags: ['always']

    - name: Display user information
      ansible.builtin.debug:
        msg: "Installing for user: {{ dfe_actual_user }} (home: {{ dfe_user_home }})"
      tags: ['always']

    - name: Detect if GNOME is running (Linux only)
      ansible.builtin.command: pgrep -x gnome-shell
      register: gnome_running_check
      failed_when: false
      changed_when: false
      when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
      tags: ['always']

    - name: Set GNOME availability fact (Linux)
      ansible.builtin.set_fact:
        dfe_has_gnome: "{{ gnome_running_check.rc == 0 }}"
      when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
      tags: ['always']

    - name: Set GNOME availability fact (macOS - N/A)
      ansible.builtin.set_fact:
        dfe_has_gnome: false
      when: ansible_facts['distribution'] == 'MacOSX'
      tags: ['always']

    - name: Display GNOME status
      ansible.builtin.debug:
        msg: "GNOME desktop: {{ 'Detected' if dfe_has_gnome else 'Not detected' }}"
      tags: ['always']

  roles:
    - role: dfe_developer
      become: "{{ ansible_facts['distribution'] != 'MacOSX' }}"
      tags: ['developer', 'base']

    - role: dfe_developer_core
      become: "{{ ansible_facts['distribution'] != 'MacOSX' }}"
      tags: ['core', 'advanced']

    - role: dfe_vm_optimizer
      become: "{{ ansible_facts['distribution'] != 'MacOSX' }}"
      tags: ['vm', 'optimizer']

    - role: dfe_rdp
      become: "{{ ansible_facts['distribution'] != 'MacOSX' }}"
      tags: ['rdp']

    - role: dfe_system_cleanup
      become: "{{ ansible_facts['distribution'] != 'MacOSX' }}"
      tags: ['always']

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          DFE Developer Environment installation complete!

          Next steps:
          1. Log out and back in for Docker group membership
          2. Reboot to apply all optimizations
          3. Configure your tools (Git, AWS CLI, etc.)
