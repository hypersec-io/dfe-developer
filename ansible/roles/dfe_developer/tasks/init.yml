---
# Bootstrap tasks - run once at the start
# Sets up common variables and validates platform

- name: Validate supported distribution
  ansible.builtin.fail:
    msg: "Unsupported distribution: {{ ansible_distribution }}. Supported: {{ dfe_supported_distros | join(', ') }}"
  when: ansible_distribution not in dfe_supported_distros

- name: Validate Fedora version
  ansible.builtin.fail:
    msg: "Unsupported Fedora version: {{ ansible_distribution_major_version }}. Minimum required: {{ dfe_min_fedora_version }}"
  when:
    - ansible_distribution == 'Fedora'
    - ansible_distribution_major_version | int < dfe_min_fedora_version

- name: Validate Ubuntu version
  ansible.builtin.fail:
    msg: "Unsupported Ubuntu version: {{ ansible_distribution_version }}. Minimum required: {{ dfe_min_ubuntu_version }}"
  when:
    - ansible_distribution == 'Ubuntu'
    - ansible_distribution_version is version(dfe_min_ubuntu_version, '<')

- name: Detect actual user (for sudo operations)
  ansible.builtin.set_fact:
    dfe_actual_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id, true) }}"

- name: Set actual user home directory
  ansible.builtin.set_fact:
    dfe_user_home: "{{ '/home/' + dfe_actual_user if dfe_actual_user != 'root' else '/root' }}"

- name: Display user information
  ansible.builtin.debug:
    msg: "Installing for user: {{ dfe_actual_user }} (home: {{ dfe_user_home }})"

- name: Detect if GNOME is running
  ansible.builtin.command: pgrep -x gnome-shell
  register: gnome_running_check
  failed_when: false
  changed_when: false

- name: Set GNOME availability fact
  ansible.builtin.set_fact:
    dfe_has_gnome: "{{ gnome_running_check.rc == 0 }}"

- name: Display GNOME status
  ansible.builtin.debug:
    msg: "GNOME desktop: {{ 'Detected' if dfe_has_gnome else 'Not detected' }}"
