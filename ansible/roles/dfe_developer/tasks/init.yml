---
# Bootstrap tasks - run once at the start
# Sets up common variables and validates platform
# NOTE: Package manager lock wait is handled in playbooks/main.yml pre_tasks

- name: Validate supported distribution
  ansible.builtin.fail:
    msg: "Unsupported distribution: {{ ansible_distribution }}. Supported: {{ dfe_supported_distros | join(', ') }}"
  when: ansible_distribution not in dfe_supported_distros

- name: Validate Fedora version
  ansible.builtin.fail:
    msg: "Unsupported Fedora version: {{ ansible_distribution_major_version }}. Minimum required: {{ dfe_min_fedora_version }}"
  when:
    - ansible_distribution == 'Fedora'
    - ansible_distribution_major_version | int < dfe_min_fedora_version

- name: Validate Ubuntu version
  ansible.builtin.fail:
    msg: "Unsupported Ubuntu version: {{ ansible_distribution_version }}. Minimum required: {{ dfe_min_ubuntu_version }}"
  when:
    - ansible_distribution == 'Ubuntu'
    - ansible_distribution_version is version(dfe_min_ubuntu_version, '<')

- name: Detect actual user (for sudo operations)
  ansible.builtin.set_fact:
    dfe_actual_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id, true) }}"

- name: Set actual user home directory (Linux)
  ansible.builtin.set_fact:
    dfe_user_home: "{{ '/home/' + dfe_actual_user if dfe_actual_user != 'root' else '/root' }}"
  when: ansible_distribution != 'MacOSX'

- name: Set actual user home directory (macOS)
  ansible.builtin.set_fact:
    dfe_user_home: "{{ '/Users/' + dfe_actual_user if dfe_actual_user != 'root' else '/var/root' }}"
  when: ansible_distribution == 'MacOSX'

- name: Display user information
  ansible.builtin.debug:
    msg: "Installing for user: {{ dfe_actual_user }} (home: {{ dfe_user_home }})"

- name: Load macOS-specific variables
  ansible.builtin.include_vars:
    file: macos.yml
  when: ansible_distribution == 'MacOSX'

- name: Create temporary sudo askpass script (macOS)
  ansible.builtin.copy:
    content: |
      #!/bin/sh
      echo "{{ ansible_become_password }}"
    dest: /tmp/askpass.sh
    mode: '0700'
  become: false
  when: ansible_distribution == 'MacOSX'

- name: Install Homebrew (macOS)
  ansible.builtin.shell: |
    export SUDO_ASKPASS=/tmp/askpass.sh
    NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  args:
    creates: /opt/homebrew/bin/brew
  become: false
  when: ansible_distribution == 'MacOSX'

# Note: askpass.sh is kept for Docker and other Homebrew cask installs
# It will be cleaned up in dfe_system_cleanup role

- name: Add Homebrew to shell profile (macOS)
  ansible.builtin.lineinfile:
    path: "{{ dfe_user_home }}/.zprofile"
    line: 'eval "$(/opt/homebrew/bin/brew shellenv)"'
    create: true
    mode: '0644'
  become: false
  when: ansible_distribution == 'MacOSX'

- name: Detect if GNOME is running (Linux only)
  ansible.builtin.command: pgrep -x gnome-shell
  register: gnome_running_check
  failed_when: false
  changed_when: false
  when:
    - ansible_distribution != 'MacOSX'
    - not (dfe_force_gnome | default(false) | bool)

- name: Check if GNOME Shell is installed (fallback for headless/template builds)
  ansible.builtin.stat:
    path: /usr/bin/gnome-shell
  register: gnome_shell_installed
  when:
    - ansible_distribution != 'MacOSX'
    - not (dfe_force_gnome | default(false) | bool)

- name: Set GNOME availability fact (Linux - running session)
  ansible.builtin.set_fact:
    dfe_has_gnome: "{{ gnome_running_check.rc == 0 }}"
  when:
    - ansible_distribution != 'MacOSX'
    - not (dfe_force_gnome | default(false) | bool)
    - gnome_running_check is defined

- name: Set GNOME availability fact (Linux - forced for headless/template builds)
  ansible.builtin.set_fact:
    dfe_has_gnome: true
  when:
    - ansible_distribution != 'MacOSX'
    - dfe_force_gnome | default(false) | bool

- name: Set GNOME availability fact (macOS - N/A)
  ansible.builtin.set_fact:
    dfe_has_gnome: false
  when: ansible_distribution == 'MacOSX'

- name: Display GNOME status
  ansible.builtin.debug:
    msg: "GNOME desktop: {{ 'Detected' if dfe_has_gnome else 'Not detected' }}"
