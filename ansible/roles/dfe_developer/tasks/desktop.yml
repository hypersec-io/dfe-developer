---
# Ensure minimal GNOME desktop environment is installed (Linux only)
# Idempotent - does nothing if full desktop already present

# ============================================================================
# FEDORA
# ============================================================================

- name: Install GNOME desktop (Fedora)
  ansible.builtin.dnf:
    name: '@gnome-desktop'
    state: present
  when: ansible_facts['distribution'] == 'Fedora'

- name: Install LibreOffice (Fedora)
  ansible.builtin.dnf:
    name: '@libreoffice'
    state: present
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - dfe_install_libreoffice | default(false)

- name: Set default target to graphical (Fedora)
  ansible.builtin.command:
    cmd: systemctl set-default graphical.target
  changed_when: true
  when: ansible_facts['distribution'] == 'Fedora'

# ============================================================================
# UBUNTU
# ============================================================================

# NOTE: install_recommends: false prevents LibreOffice from being pulled in
# LibreOffice is opt-in via dfe_install_libreoffice variable
- name: Install GNOME desktop (Ubuntu)
  ansible.builtin.apt:
    name: ubuntu-desktop-minimal
    state: present
    install_recommends: false
  when: ansible_facts['distribution'] == 'Ubuntu'

- name: Install LibreOffice (Ubuntu)
  ansible.builtin.apt:
    name: libreoffice
    state: present
  when:
    - ansible_facts['distribution'] == 'Ubuntu'
    - dfe_install_libreoffice | default(false)

- name: Set default target to graphical (Ubuntu)
  ansible.builtin.command:
    cmd: systemctl set-default graphical.target
  changed_when: true
  when: ansible_facts['distribution'] == 'Ubuntu'

# ============================================================================
# DISABLE GNOME INITIAL SETUP (Ubuntu Welcome wizard)
# ============================================================================
# Multiple suppression methods to ensure wizard never appears:
# 1. Remove the autostart desktop file
# 2. Create system-wide done file in /etc/skel (for new users)
# 3. Create done file for the target user
# 4. Disable via dconf (system-wide)

- name: Disable gnome-initial-setup for all users
  ansible.builtin.file:
    path: /etc/xdg/autostart/gnome-initial-setup-first-login.desktop
    state: absent
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

# System-wide suppression via /etc/skel (copied to new user home dirs)
- name: Ensure /etc/skel/.config exists
  ansible.builtin.file:
    path: /etc/skel/.config
    state: directory
    mode: '0755'
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Create gnome-initial-setup-done in /etc/skel (system-wide)
  ansible.builtin.copy:
    dest: /etc/skel/.config/gnome-initial-setup-done
    content: "yes"
    mode: '0644'
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

# Create gnome-initial-setup-done file for the configured user
# This prevents the wizard from appearing even if the autostart file returns
- name: Ensure user .config directory exists
  ansible.builtin.file:
    path: "{{ dfe_user_home }}/.config"
    state: directory
    owner: "{{ dfe_actual_user }}"
    mode: '0700'
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Create gnome-initial-setup-done for target user
  ansible.builtin.copy:
    dest: "{{ dfe_user_home }}/.config/gnome-initial-setup-done"
    content: "yes"
    owner: "{{ dfe_actual_user }}"
    mode: '0644'
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

# ============================================================================
# USER AVATAR (configurable logo on GDM login screen)
# ============================================================================
# Set dfe_avatar_file to empty string to skip avatar deployment
# Default: hypersec-avatar.svg

- name: Deploy user avatar
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - dfe_avatar_file | default('') | length > 0
  block:
    # GDM reads avatar from /var/lib/AccountsService/icons/<username>
    - name: Create AccountsService icons directory
      ansible.builtin.file:
        path: /var/lib/AccountsService/icons
        state: directory
        mode: '0755'

    # SVG must be converted to PNG for AccountsService (uses librsvg)
    - name: Install librsvg for SVG to PNG conversion (Ubuntu)
      ansible.builtin.apt:
        name: librsvg2-bin
        state: present
      when: ansible_facts['distribution'] == 'Ubuntu'

    - name: Install librsvg for SVG to PNG conversion (Fedora)
      ansible.builtin.dnf:
        name: librsvg2-tools
        state: present
      when: ansible_facts['distribution'] == 'Fedora'

    - name: Deploy avatar SVG
      ansible.builtin.copy:
        src: "{{ dfe_avatar_file }}"
        dest: /usr/local/share/dfe-avatar.svg
        mode: '0644'

    - name: Convert SVG to PNG for AccountsService (96x96 recommended)
      ansible.builtin.command:
        cmd: rsvg-convert -w 96 -h 96 /usr/local/share/dfe-avatar.svg -o /var/lib/AccountsService/icons/{{ dfe_actual_user }}
      changed_when: true

    # Configure AccountsService to use the custom icon
    - name: Configure AccountsService user entry
      ansible.builtin.copy:
        dest: /var/lib/AccountsService/users/{{ dfe_actual_user }}
        content: |
          [User]
          Icon=/var/lib/AccountsService/icons/{{ dfe_actual_user }}
        mode: '0644'

# ============================================================================
# DEFAULT BROWSER (set Brave as default)
# ============================================================================

- name: Set Brave as default browser
  ansible.builtin.command:
    cmd: xdg-settings set default-web-browser brave-browser.desktop
  become: true
  become_user: "{{ dfe_actual_user }}"
  changed_when: true
  failed_when: false
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
