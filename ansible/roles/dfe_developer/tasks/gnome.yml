---
# GNOME Desktop customizations and extensions

# ============================================================================
# PREREQUISITES
# ============================================================================

- name: Install psutil for dconf module (Fedora)
  ansible.builtin.dnf:
    name: python3-psutil
    state: present
  when: ansible_distribution == 'Fedora'

- name: Install psutil for dconf module (Ubuntu)
  ansible.builtin.apt:
    name: python3-psutil
    state: present
  when: ansible_distribution == 'Ubuntu'

# ============================================================================
# GNOME EXTENSIONS & APPLICATIONS (LINUX ONLY)
# ============================================================================

- name: Install GNOME extensions and Firefox (Fedora)
  block:
    - name: Install GNOME extensions and applications
      ansible.builtin.dnf:
        name:
          - firefox
          - gnome-extensions-app
          - gnome-shell-extension-system-monitor
          - gnome-shell-extension-appindicator
          - gnome-shell-extension-dash-to-panel
        state: present

  when: ansible_distribution == 'Fedora'

- name: Install GNOME extensions and Firefox (Ubuntu)
  block:
    - name: Install Firefox and GNOME extensions app
      ansible.builtin.apt:
        name:
          - firefox
          - gnome-shell-extensions
          - gnome-shell-extension-manager
          - unzip
        state: present

    - name: Install System Monitor extension (Ubuntu)
      ansible.builtin.apt:
        name: gnome-shell-extension-system-monitor
        state: present
      failed_when: false  # May not be available on all Ubuntu versions

    - name: Install AppIndicator extension (Ubuntu)
      ansible.builtin.apt:
        name: gnome-shell-extension-appindicator
        state: present
      failed_when: false  # May not be available on all Ubuntu versions

    # NOTE: Dash to Panel extension has compatibility issues with Ubuntu 24.04/GNOME 46
    # The extension system shows "already installed...will not be loaded" errors
    # Instead, we configure Ubuntu Dock to behave more like a Windows-style taskbar

  when: ansible_distribution == 'Ubuntu'

# ============================================================================
# SYSTEM-WIDE DCONF DEFAULTS (applies to ALL users)
# ============================================================================
# This sets defaults that new users get automatically.
# Users can still override these in their own dconf settings.

- name: Configure system-wide GNOME defaults
  block:
    - name: Create dconf local.d directory
      ansible.builtin.file:
        path: /etc/dconf/db/local.d
        state: directory
        mode: '0755'

    - name: Create dconf profile directory
      ansible.builtin.file:
        path: /etc/dconf/profile
        state: directory
        mode: '0755'

    - name: Deploy dconf profile for users
      ansible.builtin.copy:
        src: dconf-profile-user
        dest: /etc/dconf/profile/user
        mode: '0644'

    - name: Deploy DFE GNOME defaults
      ansible.builtin.copy:
        src: dconf-dfe-defaults
        dest: /etc/dconf/db/local.d/00-dfe-defaults
        mode: '0644'
      register: dconf_defaults

    - name: Update dconf database
      ansible.builtin.command:
        cmd: dconf update
      when: dconf_defaults.changed

  when:
    - ansible_distribution in ['Fedora', 'Ubuntu']
    - dfe_customize_gnome_shell | default(true) | bool

# ============================================================================
# CONFIGURE ANSIBLE USER (for immediate effect without re-login)
# ============================================================================
# Apply same settings to the Ansible user so they take effect immediately.

- name: Configure GNOME Shell extensions for Ansible user
  block:
    - name: Enable global extensions toggle
      community.general.dconf:
        key: "/org/gnome/shell/disable-user-extensions"
        value: "false"
        state: present
      become: false

    - name: Enable GNOME Shell extensions
      community.general.dconf:
        key: "/org/gnome/shell/enabled-extensions"
        value: "['system-monitor@gnome-shell-extensions.gcampax.github.com', 'appindicatorsupport@rgcjonas.gmail.com', 'dash-to-panel@jderose9.github.com', 'ubuntu-appindicators@ubuntu.com', 'ubuntu-dock@ubuntu.com']"
        state: present
      become: false

    - name: Disable unused extensions
      community.general.dconf:
        key: "/org/gnome/shell/disabled-extensions"
        value: "['workspace-indicator@gnome-shell-extensions.gcampax.github.com', 'apps-menu@gnome-shell-extensions.gcampax.github.com']"
        state: present
      become: false

    - name: Configure System Monitor extension - show CPU
      community.general.dconf:
        key: "/org/gnome/shell/extensions/system-monitor/show-cpu"
        value: "true"
        state: present
      become: false

    - name: Configure System Monitor extension - show memory
      community.general.dconf:
        key: "/org/gnome/shell/extensions/system-monitor/show-memory"
        value: "true"
        state: present
      become: false

    - name: Configure System Monitor extension - hide download
      community.general.dconf:
        key: "/org/gnome/shell/extensions/system-monitor/show-download"
        value: "false"
        state: present
      become: false

    - name: Configure System Monitor extension - hide upload
      community.general.dconf:
        key: "/org/gnome/shell/extensions/system-monitor/show-upload"
        value: "false"
        state: present
      become: false

    - name: Configure System Monitor extension - hide swap
      community.general.dconf:
        key: "/org/gnome/shell/extensions/system-monitor/show-swap"
        value: "false"
        state: present
      become: false

    # -------------------------------------------------------------------------
    # Ubuntu Dock configuration (Windows-like taskbar)
    # Only applies on Ubuntu where dash-to-panel doesn't work
    # -------------------------------------------------------------------------

    - name: Configure Ubuntu Dock - position at bottom
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-dock/dock-position"
        value: "'BOTTOM'"
        state: present
      become: false
      when: ansible_distribution == 'Ubuntu'

    - name: Configure Ubuntu Dock - extend to full width
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-dock/extend-height"
        value: "true"
        state: present
      become: false
      when: ansible_distribution == 'Ubuntu'

    - name: Configure Ubuntu Dock - always visible (no auto-hide)
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-dock/dock-fixed"
        value: "true"
        state: present
      become: false
      when: ansible_distribution == 'Ubuntu'

    - name: Configure Ubuntu Dock - disable autohide
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-dock/autohide"
        value: "false"
        state: present
      become: false
      when: ansible_distribution == 'Ubuntu'

    - name: Configure Ubuntu Dock - disable intellihide
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-dock/intellihide"
        value: "false"
        state: present
      become: false
      when: ansible_distribution == 'Ubuntu'

    - name: Configure Ubuntu Dock - click to minimize
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-dock/click-action"
        value: "'minimize'"
        state: present
      become: false
      when: ansible_distribution == 'Ubuntu'

    - name: Configure Ubuntu Dock - running indicator style
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-dock/running-indicator-style"
        value: "'DOTS'"
        state: present
      become: false
      when: ansible_distribution == 'Ubuntu'

    - name: Configure Ubuntu Dock - icon size
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-dock/dash-max-icon-size"
        value: "48"
        state: present
      become: false
      when: ansible_distribution == 'Ubuntu'

    - name: Configure Ubuntu Dock - transparency
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-dock/transparency-mode"
        value: "'FIXED'"
        state: present
      become: false
      when: ansible_distribution == 'Ubuntu'

    - name: Configure Ubuntu Dock - background opacity
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-dock/background-opacity"
        value: "0.8"
        state: present
      become: false
      when: ansible_distribution == 'Ubuntu'

    - name: Configure Ubuntu Dock - hide trash
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-dock/show-trash"
        value: "false"
        state: present
      become: false
      when: ansible_distribution == 'Ubuntu'

    - name: Configure Ubuntu Dock - hide mounts
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-dock/show-mounts"
        value: "false"
        state: present
      become: false
      when: ansible_distribution == 'Ubuntu'

    - name: Enable window title bar buttons (minimize, maximize, close)
      community.general.dconf:
        key: "/org/gnome/desktop/wm/preferences/button-layout"
        value: "':minimize,maximize,close'"
        state: present
      become: false

    - name: Set dark theme preference
      community.general.dconf:
        key: "/org/gnome/desktop/interface/color-scheme"
        value: "'prefer-dark'"
        state: present
      become: false

  when:
    - ansible_distribution in ['Fedora', 'Ubuntu']
    - dfe_customize_gnome_shell | default(true) | bool

