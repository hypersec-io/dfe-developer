---
# GNOME Desktop customizations and extensions
# This file orchestrates GNOME configuration based on tags:
# - 'winlike': Windows-style taskbar (Dash to Panel)
# - 'maclike': macOS-style dock (Dash to Dock + Logo Menu + Magic Lamp)
#
# Usage: --tags winlike OR --tags maclike
# If neither tag is specified, GNOME is left untouched.

# ============================================================================
# WINDOWS-LIKE GNOME CONFIGURATION (--tags winlike)
# ============================================================================

- name: Apply Windows-like GNOME configuration
  ansible.builtin.include_tasks:
    file: gnome_winlike.yml
    apply:
      tags: ['winlike']
  tags: ['winlike', 'never']
  when:
    - dfe_has_gnome | default(false)
    - ansible_distribution in ['Ubuntu', 'Fedora']

# ============================================================================
# MACOS-LIKE GNOME CONFIGURATION (--tags maclike)
# ============================================================================

- name: Apply macOS-like GNOME configuration
  ansible.builtin.include_tasks:
    file: gnome_maclike.yml
    apply:
      tags: ['maclike']
  tags: ['maclike', 'never']
  when:
    - dfe_has_gnome | default(false)
    - ansible_distribution in ['Ubuntu', 'Fedora']

# ============================================================================
# SYSTEM-WIDE DCONF DEFAULTS (winlike)
# ============================================================================

- name: Configure system-wide GNOME defaults (winlike)
  block:
    - name: Create dconf local.d directory
      ansible.builtin.file:
        path: /etc/dconf/db/local.d
        state: directory
        mode: '0755'

    - name: Create dconf profile directory
      ansible.builtin.file:
        path: /etc/dconf/profile
        state: directory
        mode: '0755'

    - name: Deploy dconf profile for users
      ansible.builtin.copy:
        src: dconf-profile-user
        dest: /etc/dconf/profile/user
        mode: '0644'

    - name: Deploy DFE GNOME defaults (winlike)
      ansible.builtin.copy:
        src: dconf-dfe-defaults-winlike
        dest: /etc/dconf/db/local.d/00-dfe-defaults
        mode: '0644'
      register: dconf_defaults_winlike

    - name: Update dconf database
      ansible.builtin.command:
        cmd: dconf update
      changed_when: true
      when: dconf_defaults_winlike.changed | default(false)

  tags: ['winlike', 'never']
  when:
    - dfe_has_gnome | default(false)
    - ansible_distribution in ['Ubuntu', 'Fedora']

# ============================================================================
# SYSTEM-WIDE DCONF DEFAULTS (maclike)
# ============================================================================

- name: Configure system-wide GNOME defaults (maclike)
  block:
    - name: Create dconf local.d directory
      ansible.builtin.file:
        path: /etc/dconf/db/local.d
        state: directory
        mode: '0755'

    - name: Create dconf profile directory
      ansible.builtin.file:
        path: /etc/dconf/profile
        state: directory
        mode: '0755'

    - name: Deploy dconf profile for users
      ansible.builtin.copy:
        src: dconf-profile-user
        dest: /etc/dconf/profile/user
        mode: '0644'

    - name: Deploy DFE GNOME defaults (maclike)
      ansible.builtin.copy:
        src: dconf-dfe-defaults-maclike
        dest: /etc/dconf/db/local.d/00-dfe-defaults
        mode: '0644'
      register: dconf_defaults_maclike

    - name: Update dconf database
      ansible.builtin.command:
        cmd: dconf update
      changed_when: true
      when: dconf_defaults_maclike.changed | default(false)

  tags: ['maclike', 'never']
  when:
    - dfe_has_gnome | default(false)
    - ansible_distribution in ['Ubuntu', 'Fedora']
