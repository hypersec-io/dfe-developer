---
# GNOME Desktop customizations and extensions

# ============================================================================
# PREREQUISITES
# ============================================================================

- name: Install psutil for dconf module (Fedora)
  ansible.builtin.dnf:
    name: python3-psutil
    state: present
  when: ansible_distribution == 'Fedora'

- name: Install psutil for dconf module (Ubuntu)
  ansible.builtin.apt:
    name: python3-psutil
    state: present
  when: ansible_distribution == 'Ubuntu'

# ============================================================================
# GNOME EXTENSIONS & APPLICATIONS (LINUX ONLY)
# ============================================================================

- name: Install GNOME extensions and Firefox (Fedora)
  block:
    - name: Install GNOME extensions and applications
      ansible.builtin.dnf:
        name:
          - firefox
          - gnome-extensions-app
          - gnome-shell-extension-system-monitor
          - gnome-shell-extension-appindicator
          - gnome-shell-extension-dash-to-panel
        state: present

  when: ansible_distribution == 'Fedora'

- name: Install GNOME extensions and Firefox (Ubuntu)
  block:
    - name: Install Firefox and GNOME extensions app
      ansible.builtin.apt:
        name:
          - firefox
          - gnome-shell-extensions
          - gnome-shell-extension-manager
          - pipx
        state: present

    - name: Install System Monitor extension (Ubuntu)
      ansible.builtin.apt:
        name: gnome-shell-extension-system-monitor
        state: present
      failed_when: false  # May not be available on all Ubuntu versions

    - name: Install AppIndicator extension (Ubuntu)
      ansible.builtin.apt:
        name: gnome-shell-extension-appindicator
        state: present
      failed_when: false  # May not be available on all Ubuntu versions

    - name: Install gnome-extensions-cli via pipx
      ansible.builtin.command:
        cmd: pipx install gnome-extensions-cli --include-deps
      args:
        creates: "{{ dfe_user_home }}/.local/bin/gext"
      become: false

    - name: Ensure pipx bin directory is in PATH
      ansible.builtin.command:
        cmd: pipx ensurepath
      become: false
      changed_when: false

    - name: Install Dash to Panel extension via gext (to system-wide location)
      ansible.builtin.shell:
        cmd: "{{ dfe_user_home }}/.local/bin/gext install --system dash-to-panel@jderose9.github.com"
      register: gext_install
      changed_when: "'is now installed' in gext_install.stdout or 'is already installed' not in gext_install.stdout"
      failed_when: false  # Don't fail if already installed

  when: ansible_distribution == 'Ubuntu'

# ============================================================================
# SYSTEM-WIDE DCONF DEFAULTS (applies to ALL users)
# ============================================================================
# This sets defaults that new users get automatically.
# Users can still override these in their own dconf settings.

- name: Configure system-wide GNOME defaults
  block:
    - name: Create dconf local.d directory
      ansible.builtin.file:
        path: /etc/dconf/db/local.d
        state: directory
        mode: '0755'

    - name: Create dconf profile directory
      ansible.builtin.file:
        path: /etc/dconf/profile
        state: directory
        mode: '0755'

    - name: Deploy dconf profile for users
      ansible.builtin.copy:
        src: dconf-profile-user
        dest: /etc/dconf/profile/user
        mode: '0644'

    - name: Deploy DFE GNOME defaults
      ansible.builtin.copy:
        src: dconf-dfe-defaults
        dest: /etc/dconf/db/local.d/00-dfe-defaults
        mode: '0644'
      register: dconf_defaults

    - name: Update dconf database
      ansible.builtin.command:
        cmd: dconf update
      when: dconf_defaults.changed

  when:
    - ansible_distribution in ['Fedora', 'Ubuntu']
    - dfe_customize_gnome_shell | default(true) | bool

# ============================================================================
# CONFIGURE ANSIBLE USER (for immediate effect without re-login)
# ============================================================================
# Apply same settings to the Ansible user so they take effect immediately.

- name: Configure GNOME Shell extensions for Ansible user
  block:
    - name: Enable global extensions toggle
      community.general.dconf:
        key: "/org/gnome/shell/disable-user-extensions"
        value: "false"
        state: present
      become: false

    - name: Enable GNOME Shell extensions
      community.general.dconf:
        key: "/org/gnome/shell/enabled-extensions"
        value: "['system-monitor@gnome-shell-extensions.gcampax.github.com', 'appindicatorsupport@rgcjonas.gmail.com', 'dash-to-panel@jderose9.github.com', 'ubuntu-appindicators@ubuntu.com']"
        state: present
      become: false

    - name: Disable Ubuntu Dock (conflicts with Dash to Panel)
      community.general.dconf:
        key: "/org/gnome/shell/disabled-extensions"
        value: "['ubuntu-dock@ubuntu.com', 'workspace-indicator@gnome-shell-extensions.gcampax.github.com', 'apps-menu@gnome-shell-extensions.gcampax.github.com']"
        state: present
      become: false

    - name: Configure System Monitor extension - show CPU
      community.general.dconf:
        key: "/org/gnome/shell/extensions/system-monitor/show-cpu"
        value: "true"
        state: present
      become: false

    - name: Configure System Monitor extension - show memory
      community.general.dconf:
        key: "/org/gnome/shell/extensions/system-monitor/show-memory"
        value: "true"
        state: present
      become: false

    - name: Configure System Monitor extension - hide download
      community.general.dconf:
        key: "/org/gnome/shell/extensions/system-monitor/show-download"
        value: "false"
        state: present
      become: false

    - name: Configure System Monitor extension - hide upload
      community.general.dconf:
        key: "/org/gnome/shell/extensions/system-monitor/show-upload"
        value: "false"
        state: present
      become: false

    - name: Configure System Monitor extension - hide swap
      community.general.dconf:
        key: "/org/gnome/shell/extensions/system-monitor/show-swap"
        value: "false"
        state: present
      become: false

    - name: Enable window title bar buttons (minimize, maximize, close)
      community.general.dconf:
        key: "/org/gnome/desktop/wm/preferences/button-layout"
        value: "':minimize,maximize,close'"
        state: present
      become: false

    - name: Configure Dash to Panel - transparency custom opacity
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-panel/trans-use-custom-opacity"
        value: "true"
        state: present
      become: false

    - name: Configure Dash to Panel - panel opacity
      community.general.dconf:
        key: "/org/gnome/shell/extensions/dash-to-panel/trans-panel-opacity"
        value: "0.4"
        state: present
      become: false

    - name: Set dark theme preference
      community.general.dconf:
        key: "/org/gnome/desktop/interface/color-scheme"
        value: "'prefer-dark'"
        state: present
      become: false

  when:
    - ansible_distribution in ['Fedora', 'Ubuntu']
    - dfe_customize_gnome_shell | default(true) | bool

