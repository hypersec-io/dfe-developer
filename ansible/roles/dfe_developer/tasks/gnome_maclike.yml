---
# macOS-like GNOME Shell configuration
# Uses ui-mode utility to configure Dash to Dock for a macOS-style experience
#
# Extensions enabled:
# - Dash to Dock: macOS-style dock with auto-hide
# - Logo Menu: macOS-style Apple menu replacement
# - Compiz Magic Lamp Effect: macOS-style minimize animation
# - Window State Manager: Remember/restore window positions across sessions
# - System Monitor: CPU/Memory in panel

# ============================================================================
# COMMON PREREQUISITES (gext, all extensions, ui-mode utility)
# ============================================================================

- name: Install common GNOME prerequisites and all extensions
  ansible.builtin.include_tasks: gnome_common.yml

# ============================================================================
# APPLY MACLIKE MODE VIA UI-MODE UTILITY
# ============================================================================

- name: Check if GNOME Shell is running
  ansible.builtin.shell: pgrep -x gnome-shell
  register: gnome_shell_running
  changed_when: false
  failed_when: false
  become: true
  become_user: "{{ dfe_actual_user }}"

- name: Get DBUS_SESSION_BUS_ADDRESS from running GNOME session
  ansible.builtin.shell: |
    gnome_pid=$(pgrep -u {{ dfe_actual_user }} -x gnome-shell | head -1)
    if [ -n "$gnome_pid" ]; then
      grep -z DBUS_SESSION_BUS_ADDRESS /proc/$gnome_pid/environ 2>/dev/null | tr '\0' '\n'
    fi
  register: dbus_addr_result
  changed_when: false
  failed_when: false
  when: gnome_shell_running.rc == 0

- name: Apply macOS-like UI mode
  ansible.builtin.command:
    cmd: /usr/local/sbin/ui-mode maclike
  become: true
  become_user: "{{ dfe_actual_user }}"
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_addr_result.stdout | regex_replace('^DBUS_SESSION_BUS_ADDRESS=', '') }}"
  changed_when: true
  when:
    - gnome_shell_running.rc == 0
    - dbus_addr_result.stdout | default('') | length > 0

- name: Save UI mode preference for first login (when GNOME not running)
  ansible.builtin.file:
    path: "{{ dfe_user_home }}/.config/dfe"
    state: directory
    owner: "{{ dfe_actual_user }}"
    mode: '0755'
  when: gnome_shell_running.rc != 0

- name: Write UI mode preference file for first login
  ansible.builtin.copy:
    dest: "{{ dfe_user_home }}/.config/dfe/ui-mode"
    content: "maclike"
    owner: "{{ dfe_actual_user }}"
    mode: '0644'
  when: gnome_shell_running.rc != 0

# ============================================================================
# WALLPAPER DEPLOYMENT (system-wide, safe from apt/dnf updates)
# ============================================================================
# Set dfe_background_file to empty string to skip background deployment

- name: Deploy custom wallpaper
  when: dfe_background_file | default('') | length > 0
  block:
    - name: Create local backgrounds directory (safe from package updates)
      ansible.builtin.file:
        path: /usr/local/share/backgrounds
        state: directory
        mode: '0755'

    - name: Deploy DFE background image
      ansible.builtin.copy:
        src: "{{ dfe_background_file }}"
        dest: /usr/local/share/backgrounds/dfe-background.svg
        mode: '0644'

    - name: Set DFE background as default (light mode)
      community.general.dconf:
        key: "/org/gnome/desktop/background/picture-uri"
        value: "'file:///usr/local/share/backgrounds/dfe-background.svg'"
        state: present
      become: false

    - name: Set DFE background as default (dark mode)
      community.general.dconf:
        key: "/org/gnome/desktop/background/picture-uri-dark"
        value: "'file:///usr/local/share/backgrounds/dfe-background.svg'"
        state: present
      become: false

    - name: Set background scaling mode
      community.general.dconf:
        key: "/org/gnome/desktop/background/picture-options"
        value: "'zoom'"
        state: present
      become: false

# ============================================================================
# UPDATE ALL EXTENSIONS
# ============================================================================

- name: Update all installed extensions to latest versions
  ansible.builtin.command:
    cmd: "{{ dfe_user_home }}/.local/bin/gext -F update"
  become: true
  become_user: "{{ dfe_actual_user }}"
  changed_when: false
  failed_when: false
  when: ansible_facts['distribution'] in ['Ubuntu', 'Fedora']
