---
# DFE Developer Environment - Main Tasks
# Maps to: fedora/install-dfe-developer.sh

- name: Initialize - Setup common variables
  ansible.builtin.include_tasks:
    file: init.yml
  tags: ['always']

- name: Ensure desktop environment is installed
  ansible.builtin.include_tasks:
    file: desktop.yml
    apply:
      tags: ['desktop']
  tags: ['desktop']
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Configure OS repositories (mirrors, performance)
  ansible.builtin.include_tasks:
    file: repository.yml
    apply:
      tags: ['repository']
  tags: ['repository']

- name: Configure security (automatic updates)
  ansible.builtin.include_tasks:
    file: security.yml
    apply:
      tags: ['security']
  tags: ['security']

- name: Install Docker
  ansible.builtin.include_tasks:
    file: docker.yml
    apply:
      tags: ['docker']
  tags: ['docker']

- name: Install development utilities
  ansible.builtin.include_tasks:
    file: utilities.yml
    apply:
      tags: ['utilities']
  tags: ['utilities']

- name: Install Python development tools
  ansible.builtin.include_tasks:
    file: uv.yml
    apply:
      tags: ['python']
  tags: ['python']

- name: Install Git and version control tools
  ansible.builtin.include_tasks:
    file: git.yml
    apply:
      tags: ['git']
  tags: ['git']

- name: Install cloud tools
  ansible.builtin.include_tasks:
    file: cloud.yml
    apply:
      tags: ['cloud']
  tags: ['cloud']

- name: Install Kubernetes tools
  ansible.builtin.include_tasks:
    file: k8s.yml
    apply:
      tags: ['k8s']
  tags: ['k8s']

- name: Install data platform tools
  ansible.builtin.include_tasks:
    file: data_tools.yml
    apply:
      tags: ['data']
  tags: ['data']

- name: Install VS Code
  ansible.builtin.include_tasks:
    file: vscode.yml
    apply:
      tags: ['vscode']
  tags: ['vscode']
  when: dfe_has_gnome | default(false)

- name: Install Google Chrome
  ansible.builtin.include_tasks:
    file: chrome.yml
    apply:
      tags: ['chrome']
  tags: ['chrome']
  when: dfe_has_gnome | default(false)

- name: Install Brave Browser
  ansible.builtin.include_tasks:
    file: brave.yml
    apply:
      tags: ['brave']
  tags: ['brave']
  when: dfe_has_gnome | default(false)

- name: Apply Windows-like GNOME configuration
  ansible.builtin.include_tasks:
    file: gnome_winlike.yml
    apply:
      tags: ['winlike']
  tags: ['winlike', 'never']
  when:
    - dfe_has_gnome | default(false)
    - "'winlike' in ansible_run_tags"

- name: Apply macOS-like GNOME configuration
  ansible.builtin.include_tasks:
    file: gnome_maclike.yml
    apply:
      tags: ['maclike']
  tags: ['maclike', 'never']
  when:
    - dfe_has_gnome | default(false)
    - "'maclike' in ansible_run_tags"

- name: Configure system-wide GNOME defaults (winlike)
  block:
    - name: Create dconf local.d directory
      ansible.builtin.file:
        path: /etc/dconf/db/local.d
        state: directory
        mode: '0755'

    - name: Create dconf profile directory
      ansible.builtin.file:
        path: /etc/dconf/profile
        state: directory
        mode: '0755'

    - name: Deploy dconf profile for users
      ansible.builtin.copy:
        src: dconf-profile-user
        dest: /etc/dconf/profile/user
        mode: '0644'

    - name: Deploy DFE GNOME defaults (winlike)
      ansible.builtin.copy:
        src: dconf-dfe-defaults-winlike
        dest: /etc/dconf/db/local.d/00-dfe-defaults
        mode: '0644'
      register: dconf_defaults_winlike

    - name: Update dconf database
      ansible.builtin.command:
        cmd: dconf update
      changed_when: true
      when: dconf_defaults_winlike.changed | default(false)
  tags: ['winlike', 'never']
  when:
    - dfe_has_gnome | default(false)
    - ansible_facts['distribution'] in ['Ubuntu', 'Fedora']
    - "'winlike' in ansible_run_tags"

- name: Configure system-wide GNOME defaults (maclike)
  block:
    - name: Create dconf local.d directory
      ansible.builtin.file:
        path: /etc/dconf/db/local.d
        state: directory
        mode: '0755'

    - name: Create dconf profile directory
      ansible.builtin.file:
        path: /etc/dconf/profile
        state: directory
        mode: '0755'

    - name: Deploy dconf profile for users
      ansible.builtin.copy:
        src: dconf-profile-user
        dest: /etc/dconf/profile/user
        mode: '0644'

    - name: Deploy DFE GNOME defaults (maclike)
      ansible.builtin.copy:
        src: dconf-dfe-defaults-maclike
        dest: /etc/dconf/db/local.d/00-dfe-defaults
        mode: '0644'
      register: dconf_defaults_maclike

    - name: Update dconf database
      ansible.builtin.command:
        cmd: dconf update
      changed_when: true
      when: dconf_defaults_maclike.changed | default(false)
  tags: ['maclike', 'never']
  when:
    - dfe_has_gnome | default(false)
    - ansible_facts['distribution'] in ['Ubuntu', 'Fedora']
    - "'maclike' in ansible_run_tags"

- name: Install Ghostty terminal
  ansible.builtin.include_tasks:
    file: ghostty.yml
    apply:
      tags: ['ghostty']
  tags: ['ghostty']
  when: dfe_has_gnome | default(false)

- name: Configure shell (bash history auto-commit)
  ansible.builtin.include_tasks:
    file: shell_config.yml
    apply:
      tags: ['shell']
  tags: ['shell']

- name: Verify base tools installation
  ansible.builtin.include_tasks:
    file: verify.yml
    apply:
      tags: ['verify']
  tags: ['verify']
