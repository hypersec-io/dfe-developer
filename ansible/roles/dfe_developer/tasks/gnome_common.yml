---
# Common GNOME Shell extension prerequisites and utilities
# Installs gnome-extensions-cli (gext) and ALL UI mode extensions
#
# This file is included by gnome_winlike.yml and gnome_maclike.yml
# All extensions are installed here; mode-specific tasks only enable/configure them

# ============================================================================
# PREREQUISITES
# ============================================================================

- name: Install psutil for dconf module (Ubuntu)
  ansible.builtin.apt:
    name: python3-psutil
    state: present
  when: ansible_distribution == 'Ubuntu'

- name: Install psutil for dconf module (Fedora)
  ansible.builtin.dnf:
    name: python3-psutil
    state: present
  when: ansible_distribution == 'Fedora'

- name: Install GNOME extension prerequisites (Ubuntu)
  ansible.builtin.apt:
    name:
      - gnome-shell-extensions       # Base extension infrastructure
      - gnome-shell-extension-manager  # GUI for managing extensions
      - gir1.2-gmenu-3.0             # Required by ArcMenu and Logo Menu
      - python3-pip                   # For pipx
      - pipx                          # Isolated Python apps
    state: present
  when: ansible_distribution == 'Ubuntu'

- name: Install GNOME extension prerequisites (Fedora)
  ansible.builtin.dnf:
    name:
      - gnome-shell-extension-common  # Base extension infrastructure
      - gnome-extensions-app          # GUI for managing extensions
      - pipx                          # Isolated Python apps
    state: present
  when: ansible_distribution == 'Fedora'

- name: Ensure pipx path is configured
  ansible.builtin.command:
    cmd: pipx ensurepath
  become: false
  changed_when: false
  when: ansible_distribution in ['Ubuntu', 'Fedora']

- name: Install gnome-extensions-cli via pipx
  community.general.pipx:
    name: gnome-extensions-cli
    state: present
    install_deps: true
  become: false
  become_user: "{{ dfe_actual_user }}"
  environment:
    PIPX_HOME: "{{ dfe_user_home }}/.local/pipx"
    PIPX_BIN_DIR: "{{ dfe_user_home }}/.local/bin"
  when: ansible_distribution in ['Ubuntu', 'Fedora']

# ============================================================================
# DEPLOY UI-MODE UTILITY
# ============================================================================

- name: Deploy ui-mode utility to /usr/local/sbin
  ansible.builtin.copy:
    src: ui-mode
    dest: /usr/local/sbin/ui-mode
    mode: '0755'
    owner: root
    group: root
  when: ansible_distribution in ['Ubuntu', 'Fedora']

# ============================================================================
# INSTALL ALL EXTENSIONS (for both winlike and maclike modes)
# Extensions are installed here; mode-specific tasks enable/configure them
# ============================================================================

# Common extension: System Monitor
- name: Install System Monitor extension via gext
  ansible.builtin.command:
    cmd: "{{ dfe_user_home }}/.local/bin/gext -F install system-monitor@gnome-shell-extensions.gcampax.github.com"
  become: true
  become_user: "{{ dfe_actual_user }}"
  register: system_monitor_install
  changed_when: "'already installed' not in system_monitor_install.stdout"
  failed_when:
    - system_monitor_install.rc != 0
    - "'already installed' not in system_monitor_install.stdout"

- name: Compile System Monitor schemas
  ansible.builtin.command:
    cmd: glib-compile-schemas {{ dfe_user_home }}/.local/share/gnome-shell/extensions/system-monitor@gnome-shell-extensions.gcampax.github.com/schemas/
  become: true
  become_user: "{{ dfe_actual_user }}"
  changed_when: false
  failed_when: false

# Common extension: Window State Manager (used by both modes)
- name: Install Window State Manager extension via gext
  ansible.builtin.command:
    cmd: "{{ dfe_user_home }}/.local/bin/gext -F install window-state-manager@kishorv06.github.io"
  become: true
  become_user: "{{ dfe_actual_user }}"
  register: window_state_install
  changed_when: "'already installed' not in window_state_install.stdout"
  failed_when:
    - window_state_install.rc != 0
    - "'already installed' not in window_state_install.stdout"

# Winlike extension: Dash to Panel
- name: Install Dash to Panel extension via gext
  ansible.builtin.command:
    cmd: "{{ dfe_user_home }}/.local/bin/gext -F install dash-to-panel@jderose9.github.com"
  become: true
  become_user: "{{ dfe_actual_user }}"
  register: dash_to_panel_install
  changed_when: "'already installed' not in dash_to_panel_install.stdout"
  failed_when:
    - dash_to_panel_install.rc != 0
    - "'already installed' not in dash_to_panel_install.stdout"

- name: Compile Dash to Panel schemas
  ansible.builtin.command:
    cmd: glib-compile-schemas {{ dfe_user_home }}/.local/share/gnome-shell/extensions/dash-to-panel@jderose9.github.com/schemas/
  become: true
  become_user: "{{ dfe_actual_user }}"
  changed_when: false
  failed_when: false

# Maclike extension: Dash to Dock
- name: Install Dash to Dock extension via gext
  ansible.builtin.command:
    cmd: "{{ dfe_user_home }}/.local/bin/gext -F install dash-to-dock@micxgx.gmail.com"
  become: true
  become_user: "{{ dfe_actual_user }}"
  register: dash_to_dock_install
  changed_when: "'already installed' not in dash_to_dock_install.stdout"
  failed_when:
    - dash_to_dock_install.rc != 0
    - "'already installed' not in dash_to_dock_install.stdout"

- name: Compile Dash to Dock schemas
  ansible.builtin.command:
    cmd: glib-compile-schemas {{ dfe_user_home }}/.local/share/gnome-shell/extensions/dash-to-dock@micxgx.gmail.com/schemas/
  become: true
  become_user: "{{ dfe_actual_user }}"
  changed_when: false
  failed_when: false

# Maclike extension: Logo Menu
- name: Install Logo Menu extension via gext
  ansible.builtin.command:
    cmd: "{{ dfe_user_home }}/.local/bin/gext -F install logomenu@aryan_k"
  become: true
  become_user: "{{ dfe_actual_user }}"
  register: logo_menu_install
  changed_when: "'already installed' not in logo_menu_install.stdout"
  failed_when:
    - logo_menu_install.rc != 0
    - "'already installed' not in logo_menu_install.stdout"

# Maclike extension: Magic Lamp effect
- name: Install Compiz Magic Lamp effect extension via gext
  ansible.builtin.command:
    cmd: "{{ dfe_user_home }}/.local/bin/gext -F install compiz-alike-magic-lamp-effect@hermes83.github.com"
  become: true
  become_user: "{{ dfe_actual_user }}"
  register: magic_lamp_install
  changed_when: "'already installed' not in magic_lamp_install.stdout"
  failed_when:
    - magic_lamp_install.rc != 0
    - "'already installed' not in magic_lamp_install.stdout"

# ============================================================================
# COMMON DCONF SETTINGS
# ============================================================================

- name: Enable global extensions toggle
  community.general.dconf:
    key: "/org/gnome/shell/disable-user-extensions"
    value: "false"
    state: present
  become: false

- name: Configure System Monitor - show CPU
  community.general.dconf:
    key: "/org/gnome/shell/extensions/system-monitor/show-cpu"
    value: "true"
    state: present
  become: false

- name: Configure System Monitor - show memory
  community.general.dconf:
    key: "/org/gnome/shell/extensions/system-monitor/show-memory"
    value: "true"
    state: present
  become: false

- name: Configure System Monitor - hide network
  community.general.dconf:
    key: "/org/gnome/shell/extensions/system-monitor/show-download"
    value: "false"
    state: present
  become: false

- name: Configure System Monitor - hide upload
  community.general.dconf:
    key: "/org/gnome/shell/extensions/system-monitor/show-upload"
    value: "false"
    state: present
  become: false

- name: Configure System Monitor - hide swap
  community.general.dconf:
    key: "/org/gnome/shell/extensions/system-monitor/show-swap"
    value: "false"
    state: present
  become: false

- name: Enable window title bar buttons (minimize, maximize, close)
  community.general.dconf:
    key: "/org/gnome/desktop/wm/preferences/button-layout"
    value: "':minimize,maximize,close'"
    state: present
  become: false

- name: Set dark theme preference
  community.general.dconf:
    key: "/org/gnome/desktop/interface/color-scheme"
    value: "'prefer-dark'"
    state: present
  become: false

# ============================================================================
# FONT INSTALLATION (system-wide fonts for consistency across distros)
# ============================================================================

# Install Martel Sans font (used for various UI elements)
- name: Create Martel Sans fonts directory
  ansible.builtin.file:
    path: /usr/local/share/fonts/martel-sans
    state: directory
    mode: '0755'
  when: ansible_distribution in ['Ubuntu', 'Fedora']

- name: Install Martel Sans fonts
  ansible.builtin.copy:
    src: "fonts/martel-sans/{{ item }}"
    dest: "/usr/local/share/fonts/martel-sans/{{ item }}"
    mode: '0644'
  loop:
    - MartelSans-Regular.ttf
    - MartelSans-Light.ttf
    - MartelSans-ExtraLight.ttf
    - MartelSans-SemiBold.ttf
    - MartelSans-Bold.ttf
    - MartelSans-ExtraBold.ttf
    - MartelSans-Black.ttf
  when: ansible_distribution in ['Ubuntu', 'Fedora']
  register: martel_fonts_installed

# ============================================================================
# FONT CONFIGURATION (Adwaita Sans for GNOME 47+ consistency across distros)
# ============================================================================

# Check if Adwaita Sans is installed (GNOME 47+ font, not available in Ubuntu 24.04)
- name: Check if Adwaita Sans font is installed
  ansible.builtin.stat:
    path: /usr/share/fonts/adwaita-sans/AdwaitaSans-Regular.ttf
  register: adwaita_sans_check
  when: ansible_distribution == 'Ubuntu'

# Install Adwaita Sans and Mono fonts on Ubuntu (to match Fedora GNOME 47+)
- name: Create Adwaita fonts directory (Ubuntu)
  ansible.builtin.file:
    path: /usr/share/fonts/adwaita-sans
    state: directory
    mode: '0755'
  when:
    - ansible_distribution == 'Ubuntu'
    - not adwaita_sans_check.stat.exists | default(true)

- name: Install Adwaita Sans fonts (Ubuntu)
  ansible.builtin.copy:
    src: "fonts/adwaita/{{ item }}"
    dest: "/usr/share/fonts/adwaita-sans/{{ item }}"
    mode: '0644'
  loop:
    - AdwaitaSans-Regular.ttf
    - AdwaitaSans-Italic.ttf
    - AdwaitaMono-Regular.ttf
    - AdwaitaMono-Bold.ttf
    - AdwaitaMono-Italic.ttf
    - AdwaitaMono-BoldItalic.ttf
  when:
    - ansible_distribution == 'Ubuntu'
    - not adwaita_sans_check.stat.exists | default(true)
  register: adwaita_fonts_installed

- name: Rebuild font cache
  ansible.builtin.command:
    cmd: fc-cache -f
  changed_when: true
  when:
    - ansible_distribution in ['Ubuntu', 'Fedora']
    - (adwaita_fonts_installed.changed | default(false)) or (martel_fonts_installed.changed | default(false))

# Set Adwaita Sans as default fonts (GNOME 47+ style for all Linux distros)
- name: Set interface font (Adwaita Sans 11)
  community.general.dconf:
    key: "/org/gnome/desktop/interface/font-name"
    value: "'Adwaita Sans 11'"
    state: present
  become: false
  when: ansible_distribution in ['Ubuntu', 'Fedora']

- name: Set document font (Adwaita Sans 11)
  community.general.dconf:
    key: "/org/gnome/desktop/interface/document-font-name"
    value: "'Adwaita Sans 11'"
    state: present
  become: false
  when: ansible_distribution in ['Ubuntu', 'Fedora']

- name: Set monospace font (Adwaita Mono 11)
  community.general.dconf:
    key: "/org/gnome/desktop/interface/monospace-font-name"
    value: "'Adwaita Mono 11'"
    state: present
  become: false
  when: ansible_distribution in ['Ubuntu', 'Fedora']

- name: Set window title font (Adwaita Sans Bold 11)
  community.general.dconf:
    key: "/org/gnome/desktop/wm/preferences/titlebar-font"
    value: "'Adwaita Sans Bold 11'"
    state: present
  become: false
  when: ansible_distribution in ['Ubuntu', 'Fedora']
