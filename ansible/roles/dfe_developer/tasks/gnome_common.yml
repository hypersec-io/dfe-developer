---
# Common GNOME Shell extension prerequisites and utilities
# Installs gnome-extensions-cli (gext) for managing extensions from extensions.gnome.org
#
# This file is included by gnome_winlike.yml and gnome_maclike.yml

# ============================================================================
# PREREQUISITES
# ============================================================================

- name: Install psutil for dconf module (Ubuntu)
  ansible.builtin.apt:
    name: python3-psutil
    state: present
  when: ansible_distribution == 'Ubuntu'

- name: Install psutil for dconf module (Fedora)
  ansible.builtin.dnf:
    name: python3-psutil
    state: present
  when: ansible_distribution == 'Fedora'

- name: Install GNOME extension prerequisites (Ubuntu)
  ansible.builtin.apt:
    name:
      - gnome-shell-extensions       # Base extension infrastructure
      - gnome-shell-extension-manager  # GUI for managing extensions
      - gir1.2-gmenu-3.0             # Required by ArcMenu and Logo Menu
      - python3-pip                   # For pipx
      - pipx                          # Isolated Python apps
    state: present
  when: ansible_distribution == 'Ubuntu'

- name: Ensure pipx path is configured
  ansible.builtin.command:
    cmd: pipx ensurepath
  become: false
  changed_when: false
  when: ansible_distribution == 'Ubuntu'

- name: Install gnome-extensions-cli via pipx
  community.general.pipx:
    name: gnome-extensions-cli
    state: present
    install_deps: true
  become: false
  become_user: "{{ dfe_actual_user }}"
  environment:
    PIPX_HOME: "{{ dfe_user_home }}/.local/pipx"
    PIPX_BIN_DIR: "{{ dfe_user_home }}/.local/bin"
  when: ansible_distribution == 'Ubuntu'

# ============================================================================
# INSTALL SYSTEM MONITOR EXTENSION (common to both styles)
# ============================================================================

- name: Install System Monitor extension via gext
  ansible.builtin.command:
    cmd: "{{ dfe_user_home }}/.local/bin/gext -F install system-monitor@gnome-shell-extensions.gcampax.github.com"
  become: true
  become_user: "{{ dfe_actual_user }}"
  register: system_monitor_install
  changed_when: "'already installed' not in system_monitor_install.stdout"
  failed_when:
    - system_monitor_install.rc != 0
    - "'already installed' not in system_monitor_install.stdout"
  when: ansible_distribution == 'Ubuntu'

# ============================================================================
# COMMON DCONF SETTINGS
# ============================================================================

- name: Enable global extensions toggle
  community.general.dconf:
    key: "/org/gnome/shell/disable-user-extensions"
    value: "false"
    state: present
  become: false

- name: Configure System Monitor - show CPU
  community.general.dconf:
    key: "/org/gnome/shell/extensions/system-monitor/show-cpu"
    value: "true"
    state: present
  become: false

- name: Configure System Monitor - show memory
  community.general.dconf:
    key: "/org/gnome/shell/extensions/system-monitor/show-memory"
    value: "true"
    state: present
  become: false

- name: Configure System Monitor - hide network
  community.general.dconf:
    key: "/org/gnome/shell/extensions/system-monitor/show-download"
    value: "false"
    state: present
  become: false

- name: Configure System Monitor - hide upload
  community.general.dconf:
    key: "/org/gnome/shell/extensions/system-monitor/show-upload"
    value: "false"
    state: present
  become: false

- name: Configure System Monitor - hide swap
  community.general.dconf:
    key: "/org/gnome/shell/extensions/system-monitor/show-swap"
    value: "false"
    state: present
  become: false

- name: Enable window title bar buttons (minimize, maximize, close)
  community.general.dconf:
    key: "/org/gnome/desktop/wm/preferences/button-layout"
    value: "':minimize,maximize,close'"
    state: present
  become: false

- name: Set dark theme preference
  community.general.dconf:
    key: "/org/gnome/desktop/interface/color-scheme"
    value: "'prefer-dark'"
    state: present
  become: false
