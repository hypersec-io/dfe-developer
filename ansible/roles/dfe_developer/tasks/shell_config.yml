---
# Shell configuration (PATH, bash history auto-commit, etc.)

# ============================================================================
# PATH CONFIGURATION (SYSTEM-WIDE)
# Add common tool directories to PATH for all users
# ============================================================================

- name: Configure DFE PATH additions system-wide (Linux)
  ansible.builtin.copy:
    dest: /etc/profile.d/dfe-path.sh
    content: |
      # DFE Developer Environment PATH additions
      # System-wide configuration for all users

      # Add ~/.cargo/bin for UV, Rust tools
      if [ -d "$HOME/.cargo/bin" ]; then
          export PATH="$HOME/.cargo/bin:$PATH"
      fi

      # Add ~/.local/bin for user-installed tools (pipx, gext, etc.)
      if [ -d "$HOME/.local/bin" ]; then
          export PATH="$HOME/.local/bin:$PATH"
      fi

      # Add ~/.npm-global/bin for npm global tools (claude, semantic-release, etc.)
      if [ -d "$HOME/.npm-global/bin" ]; then
          export PATH="$HOME/.npm-global/bin:$PATH"
      fi
    mode: '0644'
  when: ansible_distribution in ['Fedora', 'Ubuntu']

# ============================================================================
# BASH HISTORY AUTO-COMMIT (SYSTEM-WIDE)
# Commands are written to history immediately (not just on shell exit)
# ============================================================================

- name: Configure bash history auto-commit system-wide (Linux)
  ansible.builtin.copy:
    dest: /etc/profile.d/bash-history-autocommit.sh
    content: |
      # Bash history auto-commit: Commands saved immediately
      # System-wide configuration for all users

      if [ -n "$BASH_VERSION" ]; then
          shopt -s histappend                      # Append to history file, don't overwrite
          PROMPT_COMMAND="history -a${PROMPT_COMMAND:+; $PROMPT_COMMAND}"  # Write to history after each command
          export HISTSIZE=10000                    # Commands in memory
          export HISTFILESIZE=20000                # Commands in file
          export HISTCONTROL=ignoredups:erasedups  # No duplicate entries
          export HISTTIMEFORMAT="%F %T "           # Timestamp format
      fi
    mode: '0644'
  when: ansible_distribution in ['Fedora', 'Ubuntu']

- name: Configure zsh history auto-commit system-wide (macOS)
  ansible.builtin.copy:
    dest: /etc/zshenv
    content: |
      # Zsh history auto-commit: Commands saved immediately
      # System-wide configuration for all users

      setopt APPEND_HISTORY                    # Append to history file
      setopt INC_APPEND_HISTORY                # Write to history immediately
      setopt HIST_IGNORE_DUPS                  # No duplicate entries
      setopt HIST_FIND_NO_DUPS                 # Don't show duplicates in search
      export HISTSIZE=10000                    # Commands in memory
      export SAVEHIST=20000                    # Commands in file
      export HISTFILE=~/.zsh_history           # History file location
    mode: '0644'
  when: ansible_distribution == 'MacOSX'

