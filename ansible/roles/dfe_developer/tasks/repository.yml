---
# Configure OS package repositories (mirrors, performance settings)
# Does NOT add vendor repos (Docker, VS Code, etc.) - those are in individual task files

# ============================================================================
# FEDORA REPOSITORY CONFIGURATION
# ============================================================================

- name: Configure Fedora mirrors (AARNET)
  block:
    - name: Disable metalink in fedora.repo
      ansible.builtin.replace:
        path: /etc/yum.repos.d/fedora.repo
        regexp: '^metalink='
        replace: '#metalink='

    - name: Add AARNET mirror to fedora.repo
      ansible.builtin.lineinfile:
        path: /etc/yum.repos.d/fedora.repo
        insertafter: '^\[fedora\]'
        line: "baseurl={{ dfe_mirror_url }}/fedora/linux/releases/$releasever/Everything/$basearch/os/"
        state: present

    - name: Disable metalink in fedora-updates.repo
      ansible.builtin.replace:
        path: /etc/yum.repos.d/fedora-updates.repo
        regexp: '^metalink='
        replace: '#metalink='

    - name: Add AARNET mirror to fedora-updates.repo
      ansible.builtin.lineinfile:
        path: /etc/yum.repos.d/fedora-updates.repo
        insertafter: '^\[updates\]'
        line: "baseurl={{ dfe_mirror_url }}/fedora/linux/updates/$releasever/Everything/$basearch/"
        state: present

    - name: Create DNF conf.d directory
      ansible.builtin.file:
        path: /etc/dnf/dnf.conf.d
        state: directory
        mode: '0755'

    - name: Configure DNF performance settings
      ansible.builtin.copy:
        dest: /etc/dnf/dnf.conf.d/99-performance.conf
        content: |
          # Performance optimizations
          max_parallel_downloads=20
          fastestmirror=False
          deltarpm=True
          timeout=30
          retries=10
          skip_if_unavailable=True
          metadata_expire=7200
        mode: '0644'

    - name: Clean DNF metadata cache
      ansible.builtin.command: dnf clean metadata
      changed_when: false

    - name: Update DNF cache
      ansible.builtin.command: dnf makecache
      changed_when: false
  when: ansible_distribution == 'Fedora'

# ============================================================================
# UBUNTU REPOSITORY CONFIGURATION
# ============================================================================

- name: Configure Ubuntu mirrors (AARNET)
  block:
    - name: Configure AARNET mirror for Ubuntu
      ansible.builtin.replace:
        path: /etc/apt/sources.list
        regexp: 'http://[a-z]{2}\.archive\.ubuntu\.com/ubuntu'
        replace: "{{ dfe_mirror_url }}/ubuntu"
        backup: true

    - name: Configure AARNET security mirror for Ubuntu
      ansible.builtin.replace:
        path: /etc/apt/sources.list
        regexp: 'http://security\.ubuntu\.com/ubuntu'
        replace: "{{ dfe_mirror_url }}/ubuntu"
        backup: true

    - name: Configure APT performance settings
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/99-performance
        content: |
          # Performance optimizations
          Acquire::http::Dl-Limit "0";
          Acquire::https::Dl-Limit "0";
          Acquire::Queue-Mode "host";
          APT::Get::Assume-Yes "false";
        mode: '0644'

    - name: Update APT cache
      ansible.builtin.apt:
        update_cache: true
  when: ansible_distribution == 'Ubuntu'
