---
# Kubernetes tools installation (kubectl, k9s, kubectx/kubens, Minikube, ArgoCD, Freelens, dive)

# ============================================================================
# KUBECTL - Dynamic version detection
# ============================================================================

- name: Detect latest stable Kubernetes version
  ansible.builtin.uri:
    url: https://dl.k8s.io/release/stable.txt
    return_content: true
  register: k8s_stable_version
  delegate_to: localhost
  become: false

- name: Extract Kubernetes minor version
  ansible.builtin.set_fact:
    k8s_version: "{{ k8s_stable_version.content | trim | regex_replace('^v([0-9]+\\.[0-9]+).*', '\\1') }}"

- name: Display detected Kubernetes version
  ansible.builtin.debug:
    msg: "Using Kubernetes {{ k8s_version }}"

# Fedora
- name: Add Kubernetes repository (Fedora)
  ansible.builtin.yum_repository:
    name: kubernetes
    description: Kubernetes
    baseurl: "https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/rpm/"
    enabled: true
    gpgcheck: true
    gpgkey: "https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/rpm/repodata/repomd.xml.key"
  when: ansible_distribution == 'Fedora'

- name: Install kubectl (Fedora)
  ansible.builtin.dnf:
    name: kubectl
    state: present
  when: ansible_distribution == 'Fedora'

# Ubuntu
- name: Add Kubernetes GPG key (Ubuntu)
  ansible.builtin.get_url:
    url: "https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/Release.key"
    dest: /etc/apt/keyrings/kubernetes-apt-keyring.asc
    mode: '0644'
  when: ansible_distribution == 'Ubuntu'

- name: Add Kubernetes repository (Ubuntu)
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.asc] https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/ /"
    filename: kubernetes
    state: present
  when: ansible_distribution == 'Ubuntu'

- name: Install kubectl (Ubuntu)
  ansible.builtin.apt:
    name: kubectl
    state: present
    update_cache: true
  when: ansible_distribution == 'Ubuntu'

# ============================================================================
# K9S - Binary download
# ============================================================================

# k9s - Binary download
- name: Get latest k9s version
  ansible.builtin.uri:
    url: https://api.github.com/repos/derailed/k9s/releases/latest
    return_content: true
  register: k9s_latest
  when: ansible_distribution in ['Fedora', 'Ubuntu']

- name: Download and extract k9s
  ansible.builtin.unarchive:
    src: "https://github.com/derailed/k9s/releases/download/{{ k9s_latest.json.tag_name }}/k9s_Linux_amd64.tar.gz"
    dest: /usr/local/bin
    remote_src: true
    include: k9s
    mode: '0755'
  when: ansible_distribution in ['Fedora', 'Ubuntu']

# kubectx and kubens
- name: Get latest kubectx version
  ansible.builtin.uri:
    url: https://api.github.com/repos/ahmetb/kubectx/releases/latest
    return_content: true
  register: kubectx_latest
  when: ansible_distribution in ['Fedora', 'Ubuntu']

- name: Download kubectx
  ansible.builtin.get_url:
    url: "https://github.com/ahmetb/kubectx/releases/download/{{ kubectx_latest.json.tag_name }}/kubectx"
    dest: /usr/local/bin/kubectx
    mode: '0755'
  when: ansible_distribution in ['Fedora', 'Ubuntu']

- name: Download kubens
  ansible.builtin.get_url:
    url: "https://github.com/ahmetb/kubectx/releases/download/{{ kubectx_latest.json.tag_name }}/kubens"
    dest: /usr/local/bin/kubens
    mode: '0755'
  when: ansible_distribution in ['Fedora', 'Ubuntu']

# Minikube
- name: Download Minikube
  ansible.builtin.get_url:
    url: https://github.com/kubernetes/minikube/releases/latest/download/minikube-linux-amd64
    dest: /tmp/minikube-linux-amd64
    mode: '0755'
  when: ansible_distribution in ['Fedora', 'Ubuntu']

- name: Install Minikube
  ansible.builtin.copy:
    src: /tmp/minikube-linux-amd64
    dest: /usr/local/bin/minikube
    mode: '0755'
    remote_src: true
  when: ansible_distribution in ['Fedora', 'Ubuntu']

- name: Remove Minikube installer
  ansible.builtin.file:
    path: /tmp/minikube-linux-amd64
    state: absent
  when: ansible_distribution in ['Fedora', 'Ubuntu']

# ArgoCD CLI
- name: Get latest ArgoCD version
  ansible.builtin.uri:
    url: https://api.github.com/repos/argoproj/argo-cd/releases/latest
    return_content: true
  register: argocd_latest
  when: ansible_distribution in ['Fedora', 'Ubuntu']

- name: Download ArgoCD CLI
  ansible.builtin.get_url:
    url: "https://github.com/argoproj/argo-cd/releases/download/{{ argocd_latest.json.tag_name }}/argocd-linux-amd64"
    dest: /usr/local/bin/argocd
    mode: '0755'
  when: ansible_distribution in ['Fedora', 'Ubuntu']

# Freelens - Flatpak (GUI only)
- name: Ensure Flathub remote configured
  community.general.flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
    method: user
  become: false
  when:
    - ansible_distribution in ['Fedora', 'Ubuntu']
    - dfe_has_gnome | default(false)

- name: Install Freelens
  community.general.flatpak:
    name: app.freelens.Freelens
    state: present
    method: user
  become: false
  environment:
    FLATPAK_TTY_PROGRESS: "0"
  when:
    - ansible_distribution in ['Fedora', 'Ubuntu']
    - dfe_has_gnome | default(false)

# dive - Docker image analyzer
- name: Get latest dive version
  ansible.builtin.uri:
    url: https://api.github.com/repos/wagoodman/dive/releases/latest
    return_content: true
  register: dive_latest
  when: ansible_distribution in ['Fedora', 'Ubuntu']

- name: Download and extract dive
  ansible.builtin.unarchive:
    src: "https://github.com/wagoodman/dive/releases/download/{{ dive_latest.json.tag_name }}/dive_{{ dive_latest.json.tag_name | regex_replace('^v', '') }}_linux_amd64.tar.gz"
    dest: /usr/local/bin
    remote_src: true
    include: dive
    mode: '0755'
  when: ansible_distribution in ['Fedora', 'Ubuntu']

# ============================================================================
# macOS - Install via Homebrew
# ============================================================================

- name: Install kubectl via Homebrew (macOS)
  community.general.homebrew:
    name: kubernetes-cli
    state: present
  become: false
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.PATH }}"
  when: ansible_distribution == 'MacOSX'

- name: Install k9s via Homebrew (macOS)
  community.general.homebrew:
    name: k9s
    state: present
  become: false
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.PATH }}"
  when: ansible_distribution == 'MacOSX'

- name: Install kubectx via Homebrew (macOS)
  community.general.homebrew:
    name: kubectx
    state: present
  become: false
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.PATH }}"
  when: ansible_distribution == 'MacOSX'

- name: Install minikube via Homebrew (macOS)
  community.general.homebrew:
    name: minikube
    state: present
  become: false
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.PATH }}"
  when: ansible_distribution == 'MacOSX'

- name: Install ArgoCD CLI via Homebrew (macOS)
  community.general.homebrew:
    name: argocd
    state: present
  become: false
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.PATH }}"
  when: ansible_distribution == 'MacOSX'

- name: Install dive via Homebrew (macOS)
  community.general.homebrew:
    name: dive
    state: present
  become: false
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.PATH }}"
  when: ansible_distribution == 'MacOSX'
