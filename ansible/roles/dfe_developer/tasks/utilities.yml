---
# Development utilities installation (jq, yq, bat, fzf, ripgrep, flatpak, etc.)

# Install Flatpak first (needed for GUI apps)
- name: Install Flatpak (Ubuntu)
  ansible.builtin.apt:
    name: flatpak
    state: present
  when: ansible_distribution == 'Ubuntu'

- name: Install Flatpak (Fedora)
  ansible.builtin.dnf:
    name: flatpak
    state: present
  when: ansible_distribution == 'Fedora'

# Configure Flathub repository (system-wide)
- name: Add Flathub repository (system-wide)
  community.general.flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
    method: system
  when: ansible_distribution in ['Fedora', 'Ubuntu']

# Configure Flathub for user-level installations (for apps like Freelens, Slack)
- name: Add Flathub repository (user-level)
  community.general.flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
    method: user
  become: false
  when:
    - ansible_distribution in ['Fedora', 'Ubuntu']
    - dfe_has_gnome | default(false)

# Common development utilities
- name: Install development utilities (Fedora)
  ansible.builtin.dnf:
    name:
      - jq
      - bat
      - fzf
      - ripgrep
      - fd-find
      - miller                # data processing (mlr command)
      - rsync
      - httpie
      - tmux
      - htop
      - lsof
      - tree
      - bind-utils
      - net-tools
      - traceroute
      - nmap
      - telnet
      - whois
      - ShellCheck
      - postgresql
      - ansible
      - parallel
    state: present
  when: ansible_distribution == 'Fedora'

- name: Install development utilities (Ubuntu)
  ansible.builtin.apt:
    name:
      - jq
      - bat
      - fzf
      - ripgrep
      - fd-find
      - sd                    # sane sed replacement
      - miller                # data processing (mlr command)
      - rsync
      - httpie
      - tmux
      - htop
      - lsof
      - tree
      - wget
      - dnsutils
      - net-tools
      - traceroute
      - nmap
      - telnet
      - netcat-openbsd
      - whois
      - shellcheck
      - postgresql-client
      - ansible
      - parallel
    state: present
  when: ansible_distribution == 'Ubuntu'

# yq - Binary download
- name: Download yq
  ansible.builtin.get_url:
    url: https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
    dest: /usr/local/bin/yq
    mode: '0755'
  when: ansible_distribution in ['Fedora', 'Ubuntu']

# sd - sane sed replacement (binary download for Fedora, apt for Ubuntu)
- name: Get latest sd version
  ansible.builtin.uri:
    url: https://api.github.com/repos/chmln/sd/releases/latest
    return_content: true
  register: sd_release
  when: ansible_distribution == 'Fedora'

- name: Download and extract sd (Fedora)
  ansible.builtin.unarchive:
    src: "https://github.com/chmln/sd/releases/download/{{ sd_release.json.tag_name }}/sd-{{ sd_release.json.tag_name }}-x86_64-unknown-linux-gnu.tar.gz"
    dest: /usr/local/bin
    remote_src: true
    extra_opts:
      - --strip-components=1
      - --wildcards
      - "*/sd"
    mode: '0755'
  when: ansible_distribution == 'Fedora'

# macOS - Install utilities via Homebrew
- name: Install development utilities (macOS)
  community.general.homebrew:
    name:
      - jq
      - bat
      - fzf
      - ripgrep
      - fd
      - sd                    # sane sed replacement
      - miller                # data processing (mlr command)
      - rsync
      - httpie
      - tmux
      - htop
      - tree
      - wget
      - bind
      - nmap
      - telnet
      - netcat
      - whois
      - shellcheck
      - postgresql@16
      - ansible
      - yq
      - parallel
    state: present
  environment: "{{ homebrew_env }}"
  become: false
  when: ansible_distribution == 'MacOSX'

# Remmina - Remote Desktop Client (Linux GUI only)
# Using Flatpak for latest version (PPA discontinued as of 2025)
# Flatpak provides better updates and cross-distro compatibility
- name: Install Remmina via Flatpak (user-specific)
  community.general.flatpak:
    name: org.remmina.Remmina
    state: present
    method: user
  become: false
  environment:
    FLATPAK_TTY_PROGRESS: "0"
  when:
    - ansible_distribution in ['Fedora', 'Ubuntu']
    - dfe_has_gnome | default(false)

# ============================================================================
# DISABLE TELEMETRY AND ADVERTISING (Corporate deployment)
# ============================================================================
# Removes promotional messages, crash reporting, and telemetry for privacy
# and to prevent data leakage in corporate environments.

# -----------------------------------------------------------------------------
# UBUNTU: Disable Ubuntu Pro/ESM advertising and telemetry
# -----------------------------------------------------------------------------
- name: Disable Ubuntu advertising and telemetry
  block:
    # --- Ubuntu Pro/ESM Advertising ---
    - name: Disable apt ESM hook (removes apt upgrade messages)
      ansible.builtin.file:
        path: /etc/apt/apt.conf.d/20apt-esm-hook.conf
        state: absent

    - name: Disable ESM MOTD message
      ansible.builtin.file:
        path: /etc/update-motd.d/91-contract-ua-esm-status
        state: absent

    - name: Disable Ubuntu Pro apt news
      ansible.builtin.command:
        cmd: pro config set apt_news=false
      register: pro_apt_news
      changed_when: "'Successfully' in pro_apt_news.stdout"
      failed_when: false

    # --- MOTD Advertising (Canonical news/ads) ---
    - name: Disable MOTD news fetching
      ansible.builtin.lineinfile:
        path: /etc/default/motd-news
        regexp: '^ENABLED='
        line: 'ENABLED=0'
        create: true
        mode: '0644'

    # --- Apport (crash reporting to Canonical) ---
    - name: Disable Apport crash reporting
      ansible.builtin.lineinfile:
        path: /etc/default/apport
        regexp: '^enabled='
        line: 'enabled=0'

    - name: Stop and disable Apport service
      ansible.builtin.systemd:
        name: apport
        state: stopped
        enabled: false
      failed_when: false

    # --- Whoopsie (error reporting daemon) ---
    - name: Stop and disable Whoopsie error reporting
      ansible.builtin.systemd:
        name: whoopsie
        state: stopped
        enabled: false
      failed_when: false

    # --- Ubuntu Report (first-run telemetry) ---
    - name: Opt out of Ubuntu Report telemetry
      ansible.builtin.command:
        cmd: ubuntu-report send no
      register: ubuntu_report
      changed_when: ubuntu_report.rc == 0
      failed_when: false

  when: ansible_distribution == 'Ubuntu'

# -----------------------------------------------------------------------------
# FEDORA: Disable ABRT and telemetry
# -----------------------------------------------------------------------------
- name: Disable Fedora telemetry
  block:
    # --- ABRT (crash reporting to Red Hat) ---
    - name: Disable ABRT crash reporting services
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        enabled: false
      loop:
        - abrt-journal-core
        - abrt-oops
        - abrt-xorg
        - abrt-vmcore
        - abrt-pstoreoops
      failed_when: false

    # --- Fedora Third Party Repos (optional, keep enabled for Chrome etc) ---
    # Not disabling fedora-third-party as it's useful for Chrome, Steam, etc.

  when: ansible_distribution == 'Fedora'

# -----------------------------------------------------------------------------
# GNOME: Disable desktop telemetry (both distros)
# -----------------------------------------------------------------------------
- name: Disable GNOME telemetry
  block:
    - name: Disable GNOME problem reporting
      community.general.dconf:
        key: "/org/gnome/desktop/privacy/report-technical-problems"
        value: "false"
        state: present
      become: false

    - name: Disable GNOME software usage stats
      community.general.dconf:
        key: "/org/gnome/desktop/privacy/send-software-usage-stats"
        value: "false"
        state: present
      become: false

  when:
    - ansible_distribution in ['Fedora', 'Ubuntu']
    - dfe_has_gnome | default(false)

# ============================================================================
# DFE ADMIN TOOLS
# ============================================================================

# add-dev-user - Script to add new developer users with full environment access
- name: Install add-dev-user script
  ansible.builtin.copy:
    src: add-dev-user
    dest: /usr/local/sbin/add-dev-user
    owner: root
    group: root
    mode: '0755'
  when: ansible_distribution in ['Fedora', 'Ubuntu']
