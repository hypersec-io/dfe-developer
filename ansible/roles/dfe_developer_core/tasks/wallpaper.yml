---
# Default wallpaper installation
# Uses default-background.svg from role's files directory

# Install psutil for dconf module (required for GNOME settings)
- name: Install psutil for dconf module (Ubuntu)
  ansible.builtin.apt:
    name: python3-psutil
    state: present
  when: ansible_facts['distribution'] == 'Ubuntu'

- name: Install psutil for dconf module (Fedora)
  ansible.builtin.dnf:
    name: python3-psutil
    state: present
  when: ansible_facts['distribution'] == 'Fedora'

- name: Set wallpaper filename
  ansible.builtin.set_fact:
    dfe_wallpaper_name: "default-background.svg"

# ============================================================================
# LINUX - Copy wallpaper and set via dconf
# ============================================================================

- name: Copy wallpaper to system backgrounds directory (Linux)
  ansible.builtin.copy:
    src: "{{ dfe_wallpaper_name }}"
    dest: "/usr/share/backgrounds/{{ dfe_wallpaper_name }}"
    mode: '0644'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - dfe_has_gnome

- name: Set GNOME wallpaper (light mode)
  community.general.dconf:
    key: "/org/gnome/desktop/background/picture-uri"
    value: "'file:///usr/share/backgrounds/{{ dfe_wallpaper_name }}'"
    state: present
  become: false
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - dfe_has_gnome

- name: Set GNOME wallpaper (dark mode)
  community.general.dconf:
    key: "/org/gnome/desktop/background/picture-uri-dark"
    value: "'file:///usr/share/backgrounds/{{ dfe_wallpaper_name }}'"
    state: present
  become: false
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - dfe_has_gnome

- name: Display wallpaper status (Linux)
  ansible.builtin.debug:
    msg: "Wallpaper set: {{ dfe_wallpaper_name }}"
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

# ============================================================================
# macOS - Install desktoppr and set wallpaper
# ============================================================================

- name: Install desktoppr via Homebrew (macOS)
  community.general.homebrew:
    name: desktoppr
    state: present
  become: false
  environment: "{{ homebrew_env }}"
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Copy wallpaper to user Pictures directory (macOS)
  ansible.builtin.copy:
    src: "{{ dfe_wallpaper_name }}"
    dest: "{{ dfe_user_home }}/Pictures/{{ dfe_wallpaper_name }}"
    mode: '0644'
  become: false
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Set macOS wallpaper using desktoppr
  ansible.builtin.command:
    cmd: desktoppr "{{ dfe_user_home }}/Pictures/{{ dfe_wallpaper_name }}"
  environment: "{{ homebrew_env }}"
  become: false
  changed_when: false
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Display wallpaper status (macOS)
  ansible.builtin.debug:
    msg: "Wallpaper set: {{ dfe_wallpaper_name }}"
  when: ansible_facts['distribution'] == 'MacOSX'
