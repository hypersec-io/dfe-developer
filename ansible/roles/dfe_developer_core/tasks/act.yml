---
# act - Run GitHub Actions locally

# ============================================================================
# FEDORA - Install via COPR repository
# ============================================================================

- name: Install act (Fedora)
  block:
    - name: Enable act COPR repository
      ansible.builtin.command:
        cmd: dnf copr enable -y goncalossilva/act
      args:
        creates: /etc/yum.repos.d/_copr:copr.fedorainfracloud.org:goncalossilva:act.repo

    - name: Install act-cli
      ansible.builtin.dnf:
        name: act-cli
        state: present

  when: ansible_distribution == 'Fedora'

# ============================================================================
# UBUNTU - Install via binary from GitHub releases
# ============================================================================

- name: Install act (Ubuntu)
  block:
    - name: Get latest act version from GitHub API
      ansible.builtin.uri:
        url: https://api.github.com/repos/nektos/act/releases/latest
        return_content: true
      register: act_release

    - name: Set act version fact
      ansible.builtin.set_fact:
        act_version: "{{ act_release.json.tag_name }}"

    - name: Download act binary tarball
      ansible.builtin.get_url:
        url: "https://github.com/nektos/act/releases/download/{{ act_version }}/act_Linux_x86_64.tar.gz"
        dest: /tmp/act.tar.gz
        mode: '0644'

    - name: Extract act binary
      ansible.builtin.unarchive:
        src: /tmp/act.tar.gz
        dest: /tmp
        remote_src: true

    - name: Install act binary
      ansible.builtin.copy:
        src: /tmp/act
        dest: /usr/local/bin/act
        mode: '0755'
        remote_src: true

    - name: Remove act installation files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/act.tar.gz
        - /tmp/act
        - /tmp/LICENSE
        - /tmp/README.md

  when: ansible_distribution == 'Ubuntu'

# ============================================================================
# MACOS - Install via Homebrew
# ============================================================================

- name: Install act (macOS)
  community.general.homebrew:
    name: act
    state: present
  become: false
  environment: "{{ homebrew_env }}"
  when: ansible_distribution == 'MacOSX'
