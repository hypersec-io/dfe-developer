---
# Bitwarden password manager installation (GUI + CLI)
# GUI: Flatpak for Linux, Homebrew Cask for macOS
# CLI: Binary download for Linux, Homebrew for macOS

# ============================================================================
# LINUX - GUI via Flatpak (system-wide)
# ============================================================================

- name: Install Bitwarden GUI via Flatpak (system-wide)
  community.general.flatpak:
    name: com.bitwarden.desktop
    state: present
    method: system
  when:
    - ansible_distribution in ['Fedora', 'Ubuntu']
    - dfe_has_gnome

# ============================================================================
# LINUX - CLI via binary download from GitHub releases
# ============================================================================

- name: Install Bitwarden CLI (Linux)
  block:
    - name: Get latest Bitwarden CLI version from GitHub API
      ansible.builtin.uri:
        url: https://api.github.com/repos/bitwarden/clients/releases
        return_content: true
      register: bw_releases

    - name: Set Bitwarden CLI version fact
      ansible.builtin.set_fact:
        bw_cli_version: "{{ bw_releases.json | selectattr('tag_name', 'match', '^cli-v') | map(attribute='tag_name') | first | regex_replace('^cli-v', '') }}"

    - name: Download Bitwarden CLI binary
      ansible.builtin.get_url:
        url: "https://github.com/bitwarden/clients/releases/download/cli-v{{ bw_cli_version }}/bw-linux-{{ bw_cli_version }}.zip"
        dest: /tmp/bw-linux.zip
        mode: '0644'

    - name: Extract Bitwarden CLI binary
      ansible.builtin.unarchive:
        src: /tmp/bw-linux.zip
        dest: /usr/local/bin
        remote_src: true
        mode: '0755'

    - name: Remove Bitwarden CLI installation file
      ansible.builtin.file:
        path: /tmp/bw-linux.zip
        state: absent

  when: ansible_distribution in ['Fedora', 'Ubuntu']

# ============================================================================
# MACOS - GUI via Homebrew Cask, CLI via Homebrew
# ============================================================================

- name: Install Bitwarden GUI (macOS)
  community.general.homebrew_cask:
    name: bitwarden
    state: present
  become: false
  environment: "{{ homebrew_cask_env }}"
  when: ansible_distribution == 'MacOSX'

- name: Install Bitwarden CLI (macOS)
  community.general.homebrew:
    name: bitwarden-cli
    state: present
  become: false
  environment: "{{ homebrew_env }}"
  when: ansible_distribution == 'MacOSX'
