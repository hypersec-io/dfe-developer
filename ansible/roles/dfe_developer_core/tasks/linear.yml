---
# Linear CLI installation (schpet/linear-cli)
# https://github.com/schpet/linear-cli

# ============================================================================
# MACOS - Install via Homebrew tap
# ============================================================================

- name: Install Linear CLI (macOS)
  community.general.homebrew:
    name: schpet/tap/linear
    state: present
  become: false
  when: ansible_distribution == 'MacOSX'

# ============================================================================
# LINUX - Install via binary from GitHub releases
# ============================================================================

- name: Install Linear CLI (Linux)
  block:
    - name: Get latest Linear CLI version from GitHub API
      ansible.builtin.uri:
        url: https://api.github.com/repos/schpet/linear-cli/releases/latest
        return_content: true
      register: linear_release

    - name: Set Linear CLI version and architecture facts
      ansible.builtin.set_fact:
        linear_version: "{{ linear_release.json.tag_name }}"
        linear_arch: "{{ 'aarch64' if ansible_architecture == 'aarch64' else 'x86_64' }}"

    - name: Download Linear CLI binary tarball
      ansible.builtin.get_url:
        url: "https://github.com/schpet/linear-cli/releases/download/{{ linear_version }}/linear-{{ linear_arch }}-unknown-linux-gnu.tar.xz"
        dest: "/tmp/linear.tar.xz"
        mode: '0644'

    - name: Extract Linear CLI binary
      ansible.builtin.unarchive:
        src: /tmp/linear.tar.xz
        dest: /tmp
        remote_src: true

    - name: Install Linear CLI binary
      ansible.builtin.copy:
        src: "/tmp/linear-{{ linear_arch }}-unknown-linux-gnu/linear"
        dest: /usr/local/bin/linear
        mode: '0755'
        remote_src: true

    - name: Remove Linear CLI installation files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/linear.tar.xz
        - "/tmp/linear-{{ linear_arch }}-unknown-linux-gnu"

  when: ansible_distribution in ['Fedora', 'Ubuntu']
