---
# Gitleaks - Secret detection tool

# ============================================================================
# MACOS - Install via Homebrew
# ============================================================================

- name: Install Gitleaks (macOS)
  community.general.homebrew:
    name: gitleaks
    state: present
  become: false
  when: ansible_facts['distribution'] == 'MacOSX'

# ============================================================================
# LINUX - Install via binary from GitHub releases
# ============================================================================

- name: Install Gitleaks (Linux)
  block:
    - name: Get latest Gitleaks version from GitHub API
      ansible.builtin.uri:
        url: https://api.github.com/repos/gitleaks/gitleaks/releases/latest
        return_content: true
      register: gitleaks_release

    - name: Set Gitleaks version fact
      ansible.builtin.set_fact:
        gitleaks_version: "{{ gitleaks_release.json.tag_name }}"

    - name: Download Gitleaks binary tarball
      ansible.builtin.get_url:
        url: "https://github.com/gitleaks/gitleaks/releases/download/{{ gitleaks_version }}/gitleaks_{{ gitleaks_version[1:] }}_linux_x64.tar.gz"
        dest: "/tmp/gitleaks.tar.gz"
        mode: '0644'

    - name: Extract Gitleaks binary
      ansible.builtin.unarchive:
        src: /tmp/gitleaks.tar.gz
        dest: /tmp
        remote_src: true

    - name: Install Gitleaks binary
      ansible.builtin.copy:
        src: /tmp/gitleaks
        dest: /usr/local/bin/gitleaks
        mode: '0755'
        remote_src: true

    - name: Remove Gitleaks installation files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/gitleaks.tar.gz
        - /tmp/gitleaks
        - /tmp/LICENSE
        - /tmp/README.md

  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
