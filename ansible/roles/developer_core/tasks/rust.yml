---
# Rust toolchain and cargo tools installation

# ============================================================
# Rust Installation (distro packages)
# ============================================================

- name: Install Rust and Cargo (Fedora)
  ansible.builtin.dnf:
    name:
      - rust
      - cargo
      - rustfmt
      - clippy
    state: present
  when: ansible_facts['distribution'] == 'Fedora'

- name: Install Rust and Cargo (Ubuntu)
  ansible.builtin.apt:
    name:
      - rustc
      - cargo
      - rustfmt
      - rust-clippy
    state: present
  when: ansible_facts['distribution'] == 'Ubuntu'

- name: Install Rust via Homebrew (macOS)
  community.general.homebrew:
    name:
      - rust
      - rustfmt
    state: present
  become: false
  environment: "{{ homebrew_env }}"
  when: ansible_facts['distribution'] == 'MacOSX'

# ============================================================
# Cargo bin directory setup
# ============================================================

- name: Create cargo bin directory (Linux)
  ansible.builtin.file:
    path: "{{ user_home }}/.cargo/bin"
    state: directory
    mode: '0755'
    owner: "{{ actual_user }}"
    group: "{{ actual_user }}"
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Create cargo bin directory (macOS)
  ansible.builtin.file:
    path: "{{ user_home }}/.cargo/bin"
    state: directory
    mode: '0755'
  become: false
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Add cargo bin to PATH in .bashrc (Linux)
  ansible.builtin.lineinfile:
    path: "{{ user_home }}/.bashrc"
    regexp: "^export PATH=.*\\.cargo/bin"
    line: 'export PATH="{{ user_home }}/.cargo/bin:$PATH"'
    state: present
    owner: "{{ actual_user }}"
    group: "{{ actual_user }}"
    create: true
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Add cargo bin to PATH in .zshrc (macOS)
  ansible.builtin.lineinfile:
    path: "{{ user_home }}/.zshrc"
    regexp: "^export PATH=.*\\.cargo/bin"
    line: 'export PATH="{{ user_home }}/.cargo/bin:$PATH"'
    state: present
    create: true
  become: false
  when: ansible_facts['distribution'] == 'MacOSX'

# ============================================================
# Cargo tools installation
# ============================================================

- name: Set cargo environment (Linux)
  ansible.builtin.set_fact:
    cargo_env:
      PATH: "{{ user_home }}/.cargo/bin:{{ ansible_facts['env'].PATH }}"
      CARGO_HOME: "{{ user_home }}/.cargo"
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Set cargo environment (macOS)
  ansible.builtin.set_fact:
    cargo_env:
      PATH: "/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:{{ user_home }}/.cargo/bin:{{ ansible_facts['env'].PATH }}"
      CARGO_HOME: "{{ user_home }}/.cargo"
  when: ansible_facts['distribution'] == 'MacOSX'

# Install cargo tools - these compile from source so may take a while
- name: Install cargo-bacon (background code checker)
  ansible.builtin.command:
    cmd: cargo install bacon
    creates: "{{ user_home }}/.cargo/bin/bacon"
  environment: "{{ cargo_env }}"
  become: "{{ ansible_facts['distribution'] != 'MacOSX' }}"
  become_user: "{{ actual_user if ansible_facts['distribution'] != 'MacOSX' else omit }}"

- name: Install cargo-nextest (test runner)
  ansible.builtin.command:
    cmd: cargo install cargo-nextest --locked
    creates: "{{ user_home }}/.cargo/bin/cargo-nextest"
  environment: "{{ cargo_env }}"
  become: "{{ ansible_facts['distribution'] != 'MacOSX' }}"
  become_user: "{{ actual_user if ansible_facts['distribution'] != 'MacOSX' else omit }}"

- name: Install cargo-deny (dependency linter)
  ansible.builtin.command:
    cmd: cargo install cargo-deny --locked
    creates: "{{ user_home }}/.cargo/bin/cargo-deny"
  environment: "{{ cargo_env }}"
  become: "{{ ansible_facts['distribution'] != 'MacOSX' }}"
  become_user: "{{ actual_user if ansible_facts['distribution'] != 'MacOSX' else omit }}"

- name: Install cargo-tarpaulin (code coverage)
  ansible.builtin.command:
    cmd: cargo install cargo-tarpaulin --locked
    creates: "{{ user_home }}/.cargo/bin/cargo-tarpaulin"
  environment: "{{ cargo_env }}"
  become: "{{ ansible_facts['distribution'] != 'MacOSX' }}"
  become_user: "{{ actual_user if ansible_facts['distribution'] != 'MacOSX' else omit }}"
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']  # Linux only (uses ptrace)

- name: Install cargo-chef (Docker layer caching)
  ansible.builtin.command:
    cmd: cargo install cargo-chef --locked
    creates: "{{ user_home }}/.cargo/bin/cargo-chef"
  environment: "{{ cargo_env }}"
  become: "{{ ansible_facts['distribution'] != 'MacOSX' }}"
  become_user: "{{ actual_user if ansible_facts['distribution'] != 'MacOSX' else omit }}"
