---
# Verification - Core developer tools

- name: Verify JFrog CLI (Linux)
  ansible.builtin.command: jf --version
  register: verify_jfrog
  changed_when: false
  failed_when: verify_jfrog.rc != 0
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Verify JFrog CLI (macOS)
  ansible.builtin.command: jf --version
  environment: "{{ homebrew_env }}"
  register: verify_jfrog
  changed_when: false
  failed_when: verify_jfrog.rc != 0
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Verify Azure CLI (Linux)
  ansible.builtin.command: az version
  register: verify_azure
  changed_when: false
  failed_when: verify_azure.rc != 0
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Verify Azure CLI (macOS)
  ansible.builtin.command: az version
  environment: "{{ homebrew_env }}"
  register: verify_azure
  changed_when: false
  failed_when: verify_azure.rc != 0
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Verify Google Cloud CLI (Linux)
  ansible.builtin.command: gcloud version --format=json
  register: verify_gcloud
  changed_when: false
  failed_when: verify_gcloud.rc != 0
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Verify Google Cloud CLI (macOS)
  ansible.builtin.command: gcloud version --format=json
  environment: "{{ homebrew_env }}"
  register: verify_gcloud
  changed_when: false
  failed_when: verify_gcloud.rc != 0
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Verify Node.js (Linux)
  ansible.builtin.command: node --version
  register: verify_node
  changed_when: false
  failed_when: verify_node.rc != 0
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Verify Node.js (macOS)
  ansible.builtin.command: node --version
  environment: "{{ homebrew_env }}"
  register: verify_node
  changed_when: false
  failed_when: verify_node.rc != 0
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Verify semantic-release
  ansible.builtin.command: "{{ user_home }}/.npm-global/bin/semantic-release --version"
  register: verify_semrel
  changed_when: false
  failed_when: verify_semrel.rc != 0
  become: false

- name: Verify Linear CLI (Linux)
  ansible.builtin.command: linear --version
  register: verify_linear
  changed_when: false
  failed_when: verify_linear.rc != 0
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Verify Linear CLI (macOS)
  ansible.builtin.command: linear --version
  environment: "{{ homebrew_env }}"
  register: verify_linear
  changed_when: false
  failed_when: verify_linear.rc != 0
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Verify OpenVPN 3 (Linux)
  ansible.builtin.command: openvpn3 version
  register: verify_openvpn
  changed_when: false
  failed_when: verify_openvpn.rc != 0
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Verify OpenVPN 3 (macOS)
  ansible.builtin.command: openvpn --version
  environment: "{{ homebrew_env }}"
  register: verify_openvpn
  changed_when: false
  failed_when: verify_openvpn.rc != 0
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Verify NetBird CLI (Linux)
  ansible.builtin.command: netbird version
  register: verify_netbird
  changed_when: false
  failed_when: verify_netbird.rc != 0
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Verify NetBird CLI (macOS)
  ansible.builtin.command: netbird version
  environment: "{{ homebrew_env }}"
  register: verify_netbird
  changed_when: false
  failed_when: verify_netbird.rc != 0
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Verify Claude Code CLI
  ansible.builtin.command: "{{ user_home }}/.npm-global/bin/claude --version"
  register: verify_claude
  changed_when: false
  failed_when: verify_claude.rc != 0
  become: false

- name: Verify Gitleaks (Linux)
  ansible.builtin.command: gitleaks version
  register: verify_gitleaks
  changed_when: false
  failed_when: verify_gitleaks.rc != 0
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Verify Gitleaks (macOS)
  ansible.builtin.command: gitleaks version
  environment: "{{ homebrew_env }}"
  register: verify_gitleaks
  changed_when: false
  failed_when: verify_gitleaks.rc != 0
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Verify act (Linux)
  ansible.builtin.command: act --version
  register: verify_act
  changed_when: false
  failed_when: verify_act.rc != 0
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Verify act (macOS)
  ansible.builtin.command: act --version
  environment: "{{ homebrew_env }}"
  register: verify_act
  changed_when: false
  failed_when: verify_act.rc != 0
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Verify Rust (Linux)
  ansible.builtin.command: "{{ user_home }}/.cargo/bin/rustc --version"
  environment:
    RUSTUP_HOME: "{{ user_home }}/.rustup"
    CARGO_HOME: "{{ user_home }}/.cargo"
  register: verify_rust
  changed_when: false
  failed_when: verify_rust.rc != 0
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Verify Rust (macOS)
  ansible.builtin.command: rustc --version
  environment: "{{ homebrew_env }}"
  register: verify_rust
  changed_when: false
  failed_when: verify_rust.rc != 0
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Verify cargo-bacon
  ansible.builtin.command: "{{ user_home }}/.cargo/bin/bacon --version"
  register: verify_bacon
  changed_when: false
  failed_when: verify_bacon.rc != 0
  become: false

- name: Verify cargo-nextest
  ansible.builtin.command: "{{ user_home }}/.cargo/bin/cargo-nextest --version"
  register: verify_nextest
  changed_when: false
  failed_when: verify_nextest.rc != 0
  become: false

- name: Verify cargo-deny
  ansible.builtin.command: "{{ user_home }}/.cargo/bin/cargo-deny --version"
  register: verify_deny
  changed_when: false
  failed_when: verify_deny.rc != 0
  become: false

- name: Verify cargo-tarpaulin (Linux only)
  ansible.builtin.command: "{{ user_home }}/.cargo/bin/cargo-tarpaulin --version"
  register: verify_tarpaulin
  changed_when: false
  failed_when: verify_tarpaulin.rc != 0
  become: false
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Verify cargo-chef
  ansible.builtin.command: "{{ user_home }}/.cargo/bin/cargo-chef --version"
  register: verify_chef
  changed_when: false
  failed_when: verify_chef.rc != 0
  become: false

- name: Display core tools verification
  ansible.builtin.debug:
    msg: |
      âœ… Core Developer Tools Verified:
      - JFrog CLI: {{ verify_jfrog.stdout | default('installed') }}
      - Azure CLI: {{ verify_azure.stdout | default('installed') }}
      - Google Cloud CLI: {{ verify_gcloud.stdout | default('installed') }}
      - Node.js: {{ verify_node.stdout | default('installed') }}
      - semantic-release: {{ verify_semrel.stdout | default('installed') }}
      - Linear CLI: {{ verify_linear.stdout | default('installed') }}
      - OpenVPN: {{ verify_openvpn.stdout | default('installed') }}
      - NetBird CLI: {{ verify_netbird.stdout | default('installed') }}
      - Claude Code CLI: {{ verify_claude.stdout | default('installed') }}
      - Gitleaks: {{ verify_gitleaks.stdout | default('installed') }}
      - act: {{ verify_act.stdout | default('installed') }}
      - Rust: {{ verify_rust.stdout | default('installed') }}
      - cargo-bacon: {{ verify_bacon.stdout | default('installed') }}
      - cargo-nextest: {{ verify_nextest.stdout | default('installed') }}
      - cargo-deny: {{ verify_deny.stdout | default('installed') }}
      - cargo-tarpaulin: {{ verify_tarpaulin.stdout | default('installed') if ansible_facts['distribution'] in ['Fedora', 'Ubuntu'] else 'N/A (Linux only)' }}
      - cargo-chef: {{ verify_chef.stdout | default('installed') }}
