---
# OnlyOffice and Mailspring installation (Linux only)
# macOS users use native apps (Apple Mail, Pages/Numbers/Keynote)
#
# Strategy: Prefer apt/dnf packages (faster, native), only use Flatpak as fallback
# - If apt/dnf package exists: use it (developer/tasks/onlyoffice.yml handles this)
# - If no apt/dnf package: install via Flatpak
# This avoids duplicate icons in app menus

# ============================================================================
# ONLYOFFICE DESKTOP EDITORS
# ============================================================================

# Check if OnlyOffice is already installed via apt/dnf
- name: Check if OnlyOffice is installed via apt/dnf
  ansible.builtin.stat:
    path: /usr/bin/onlyoffice-desktopeditors
  register: onlyoffice_native
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

# Only install Flatpak if native package not present
- name: Install OnlyOffice via Flatpak (system-wide, fallback only)
  community.general.flatpak:
    name: org.onlyoffice.desktopeditors
    state: present
    method: system
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome | default(false)
    - not (onlyoffice_native.stat.exists | default(false))

# Determine correct desktop file name based on installation method
- name: Set OnlyOffice desktop file variable
  ansible.builtin.set_fact:
    onlyoffice_desktop_file: "{{ 'onlyoffice-desktopeditors.desktop' if (onlyoffice_native.stat.exists | default(false)) else 'org.onlyoffice.desktopeditors.desktop' }}"
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

# Set OnlyOffice as default for common document types
- name: Set OnlyOffice as default for office documents
  ansible.builtin.command:
    cmd: "xdg-mime default {{ onlyoffice_desktop_file }} {{ item }}"
  loop:
    # Word documents
    - application/msword
    - application/vnd.openxmlformats-officedocument.wordprocessingml.document
    - application/vnd.oasis.opendocument.text
    # Excel spreadsheets
    - application/vnd.ms-excel
    - application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
    - application/vnd.oasis.opendocument.spreadsheet
    # PowerPoint presentations
    - application/vnd.ms-powerpoint
    - application/vnd.openxmlformats-officedocument.presentationml.presentation
    - application/vnd.oasis.opendocument.presentation
  become: true
  become_user: "{{ actual_user }}"
  changed_when: true
  failed_when: false
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome | default(false)

# ============================================================================
# MAILSPRING EMAIL CLIENT
# ============================================================================

- name: Install Mailspring via Flatpak (system-wide)
  community.general.flatpak:
    name: com.getmailspring.Mailspring
    state: present
    method: system
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome | default(false)

# Set Mailspring as default email client
- name: Set Mailspring as default email client
  ansible.builtin.command:
    cmd: xdg-mime default com.getmailspring.Mailspring.desktop x-scheme-handler/mailto
  become: true
  become_user: "{{ actual_user }}"
  changed_when: true
  failed_when: false
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome | default(false)
