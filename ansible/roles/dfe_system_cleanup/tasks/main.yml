---
# System cleanup and updates - runs at the end of playbook
# Updates all packages and removes unused dependencies

- name: Update all packages (Fedora)
  ansible.builtin.dnf:
    name: "*"
    state: latest
    update_cache: true
  when: ansible_distribution == 'Fedora'

- name: Remove unused packages (Fedora)
  ansible.builtin.dnf:
    autoremove: true
  when: ansible_distribution == 'Fedora'

- name: Clean DNF cache (Fedora)
  ansible.builtin.command: dnf clean all
  changed_when: false
  when: ansible_distribution == 'Fedora'

- name: Update all packages (Ubuntu)
  ansible.builtin.apt:
    upgrade: dist
    update_cache: true
    cache_valid_time: 3600
  when: ansible_distribution == 'Ubuntu'

- name: Remove unused packages (Ubuntu)
  ansible.builtin.apt:
    autoremove: true
    purge: true
  when: ansible_distribution == 'Ubuntu'

- name: Clean APT cache (Ubuntu)
  ansible.builtin.apt:
    autoclean: true
  when: ansible_distribution == 'Ubuntu'

- name: Update all packages via Homebrew (macOS)
  community.general.homebrew:
    update_homebrew: true
    upgrade_all: true
  become: false
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.PATH }}"
  when: ansible_distribution == 'MacOSX'

- name: Clean Homebrew cache (macOS)
  ansible.builtin.command: brew cleanup
  become: false
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.PATH }}"
  changed_when: false
  when: ansible_distribution == 'MacOSX'

- name: Display cleanup status
  ansible.builtin.debug:
    msg: "System updated and cleaned successfully"

- name: Remove temporary askpass script (macOS)
  ansible.builtin.file:
    path: /tmp/askpass.sh
    state: absent
  become: false
  when: ansible_distribution == "MacOSX"
