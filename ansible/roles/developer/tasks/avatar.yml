---
# Avatar deployment for GDM login screen
# Separated from init.yml so it can run after desktop.yml installs GNOME
#
# Deploys custom avatar for:
# - Current user: /var/lib/AccountsService/icons/<username>
# - System default: /usr/share/pixmaps/faces/default-user.png
#
# Controlled by branding_enabled and avatar_file variables

- name: Deploy user avatar for current user
  ansible.builtin.copy:
    src: "{{ avatar_file }}"
    dest: "/var/lib/AccountsService/icons/{{ actual_user }}"
    mode: '0644'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome | default(false)
    - branding_enabled | default(true)
    - avatar_file | default('') | length > 0

- name: Ensure AccountsService user config file exists
  ansible.builtin.file:
    path: "/var/lib/AccountsService/users/{{ actual_user }}"
    state: touch
    mode: '0600'
    modification_time: preserve
    access_time: preserve
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome | default(false)
    - branding_enabled | default(true)
    - avatar_file | default('') | length > 0

- name: Ensure [User] section exists in AccountsService config
  ansible.builtin.lineinfile:
    path: "/var/lib/AccountsService/users/{{ actual_user }}"
    regexp: '^\[User\]'
    line: "[User]"
    insertbefore: BOF
    mode: '0600'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome | default(false)
    - branding_enabled | default(true)
    - avatar_file | default('') | length > 0

- name: Configure AccountsService to use custom avatar for current user
  ansible.builtin.lineinfile:
    path: "/var/lib/AccountsService/users/{{ actual_user }}"
    regexp: '^Icon='
    line: "Icon=/var/lib/AccountsService/icons/{{ actual_user }}"
    insertafter: '^\[User\]'
    mode: '0600'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome | default(false)
    - branding_enabled | default(true)
    - avatar_file | default('') | length > 0

# Set as system-wide default for new users
- name: Ensure faces directory exists for default avatars
  ansible.builtin.file:
    path: /usr/share/pixmaps/faces
    state: directory
    mode: '0755'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome | default(false)
    - branding_enabled | default(true)
    - avatar_file | default('') | length > 0

- name: Deploy avatar as system default for new users
  ansible.builtin.copy:
    src: "{{ avatar_file }}"
    dest: /usr/share/pixmaps/faces/default-user.png
    mode: '0644'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome | default(false)
    - branding_enabled | default(true)
    - avatar_file | default('') | length > 0

- name: Ensure dconf database directory exists
  ansible.builtin.file:
    path: /etc/dconf/db/local.d
    state: directory
    mode: '0755'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome | default(false)
    - branding_enabled | default(true)
    - avatar_file | default('') | length > 0

- name: Configure AccountsService default icon path
  ansible.builtin.copy:
    dest: /etc/dconf/db/local.d/01-default-avatar
    content: |
      [org/gnome/login-screen]
      logo='/usr/share/pixmaps/faces/default-user.png'
    mode: '0644'
  register: default_avatar_dconf
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - has_gnome | default(false)
    - branding_enabled | default(true)
    - avatar_file | default('') | length > 0

- name: Update dconf database for default avatar
  ansible.builtin.command:
    cmd: dconf update
  changed_when: true
  when:
    - default_avatar_dconf.changed | default(false)
