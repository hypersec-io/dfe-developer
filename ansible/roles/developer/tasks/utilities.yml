---
# Development utilities installation

# ============================================================================
# CLI UTILITIES (no desktop required)
# ============================================================================

- name: Install CLI utilities (Fedora)
  ansible.builtin.dnf:
    name:
      - jq
      - bat
      - fzf
      - ripgrep
      - fd-find
      - miller                # data processing (mlr command)
      - rsync
      - httpie
      - tmux
      - htop
      - lsof
      - tree
      - wget
      - bind-utils
      - net-tools
      - traceroute
      - nmap
      - telnet
      - whois
      - ShellCheck
      - postgresql
      - ansible
      - parallel
      - python3               # base interpreter
      - python3-pytest        # testing framework
      - age                   # file encryption
    state: present
  when: ansible_facts['distribution'] == 'Fedora'

- name: Install CLI utilities (Ubuntu)
  ansible.builtin.apt:
    name:
      - jq
      - bat
      - fzf
      - ripgrep
      - fd-find
      - sd                    # sane sed replacement
      - miller                # data processing (mlr command)
      - rsync
      - httpie
      - tmux
      - htop
      - lsof
      - tree
      - wget
      - dnsutils
      - net-tools
      - traceroute
      - nmap
      - telnet
      - netcat-openbsd
      - whois
      - shellcheck
      - postgresql-client
      - ansible
      - parallel
      - python3               # base interpreter
      - python3-pytest        # testing framework
      - age                   # file encryption
    state: present
  when: ansible_facts['distribution'] == 'Ubuntu'

- name: Install CLI utilities (macOS)
  community.general.homebrew:
    name:
      - jq
      - bat
      - fzf
      - ripgrep
      - fd
      - sd                    # sane sed replacement
      - miller                # data processing (mlr command)
      - rsync
      - httpie
      - tmux
      - htop
      - tree
      - wget
      - bind
      - nmap
      - telnet
      - netcat
      - whois
      - shellcheck
      - postgresql@16
      - ansible
      - yq
      - parallel
      - python@3              # base interpreter
      - pytest                # testing framework
      - age                   # file encryption
    state: present
  environment: "{{ homebrew_env }}"
  become: false
  when: ansible_facts['distribution'] == 'MacOSX'

# yq - Binary download (Linux only, macOS uses Homebrew above)
- name: Download yq
  ansible.builtin.get_url:
    url: https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
    dest: /usr/local/bin/yq
    mode: '0755'
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

# sd - sane sed replacement (binary download for Fedora, apt for Ubuntu)
- name: Get latest sd version
  ansible.builtin.uri:
    url: https://api.github.com/repos/chmln/sd/releases/latest
    return_content: true
  register: sd_release
  when: ansible_facts['distribution'] == 'Fedora'

- name: Download and extract sd (Fedora)
  ansible.builtin.unarchive:
    src: "https://github.com/chmln/sd/releases/download/{{ sd_release.json.tag_name }}/sd-{{ sd_release.json.tag_name }}-x86_64-unknown-linux-gnu.tar.gz"
    dest: /usr/local/bin
    remote_src: true
    extra_opts:
      - --strip-components=1
      - --wildcards
      - "*/sd"
    mode: '0755'
  when: ansible_facts['distribution'] == 'Fedora'

# ============================================================================
# GUI UTILITIES (requires GNOME desktop)
# ============================================================================

- name: Install GUI utilities
  when: has_gnome | default(false)
  block:
    # Flatpak (needed for GUI apps)
    - name: Install Flatpak (Ubuntu)
      ansible.builtin.apt:
        name: flatpak
        state: present
      when: ansible_facts['distribution'] == 'Ubuntu'

    - name: Install Flatpak (Fedora)
      ansible.builtin.dnf:
        name: flatpak
        state: present
      when: ansible_facts['distribution'] == 'Fedora'

    - name: Add Flathub repository (system-wide)
      community.general.flatpak_remote:
        name: flathub
        state: present
        flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
        method: system
      when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

    # Remmina - Remote Desktop Client
    # Using Flatpak for latest version (PPA discontinued as of 2025)
    # ignore_errors: Flathub can be slow/unreliable, don't fail build
    - name: Install Remmina via Flatpak (system-wide)
      community.general.flatpak:
        name: org.remmina.Remmina
        state: present
        method: system
      when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
      ignore_errors: true
      register: remmina_install

    - name: Install Remmina via apt (Ubuntu fallback)
      ansible.builtin.apt:
        name: remmina
        state: present
      when:
        - ansible_facts['distribution'] == 'Ubuntu'
        - remmina_install is defined
        - remmina_install is failed

    - name: Warn if Remmina installation failed (Fedora only)
      ansible.builtin.debug:
        msg: "WARNING: Remmina Flatpak install failed (Flathub timeout). Install manually: flatpak install flathub org.remmina.Remmina"
      when:
        - ansible_facts['distribution'] == 'Fedora'
        - remmina_install is defined
        - remmina_install is failed

# ============================================================================
# DFE ADMIN TOOLS
# ============================================================================

- name: Ensure /usr/local/sbin exists
  ansible.builtin.file:
    path: /usr/local/sbin
    state: directory
    mode: '0755'
    owner: root
    group: root
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

# add-dev-user - Script to add new developer users with full environment access
- name: Install add-dev-user script
  ansible.builtin.copy:
    src: add-dev-user
    dest: /usr/local/sbin/add-dev-user
    owner: root
    group: root
    mode: '0755'
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

# rename-user - Rename default template user and update RDP credentials
- name: Install rename-user script
  ansible.builtin.copy:
    src: rename-user
    dest: /usr/local/sbin/rename-user
    owner: root
    group: root
    mode: '0755'
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
