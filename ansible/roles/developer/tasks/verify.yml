---
# Verification - Base developer tools (Tier 1: Functional checks)

# Docker verification
- name: Verify Docker installed (Linux)
  ansible.builtin.command: docker --version
  register: verify_docker
  changed_when: false
  failed_when: verify_docker.rc != 0
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Verify Docker Desktop installed (macOS - CLI available after manual launch)
  ansible.builtin.stat:
    path: /Applications/Docker.app
  register: verify_docker_app
  failed_when: not verify_docker_app.stat.exists
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Set Docker version fact for macOS
  ansible.builtin.set_fact:
    verify_docker:
      stdout: "Docker Desktop installed (launch manually for CLI access)"
      rc: 0
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Verify Docker service enabled (will be active after reboot)
  ansible.builtin.systemd:
    name: docker.service
  register: verify_docker_service
  failed_when: verify_docker_service.status.UnitFileState != 'enabled'
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

# Docker group membership requires logout/reboot - skip verification

# Kubernetes tools
- name: Verify kubectl
  ansible.builtin.command: kubectl version --client
  register: verify_kubectl
  environment:
    PATH: "/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:{{ user_home }}/.cargo/bin:{{ ansible_facts['env'].PATH }}"
  changed_when: false
  failed_when: verify_kubectl.rc != 0

- name: Verify Helm
  ansible.builtin.command: helm version --short
  register: verify_helm
  environment:
    PATH: "/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:{{ user_home }}/.cargo/bin:{{ ansible_facts['env'].PATH }}"
  changed_when: false
  failed_when: verify_helm.rc != 0

- name: Verify Terraform
  ansible.builtin.command: terraform version
  register: verify_terraform
  environment:
    PATH: "/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:{{ user_home }}/.cargo/bin:{{ ansible_facts['env'].PATH }}"
  changed_when: false
  failed_when: verify_terraform.rc != 0

# Git verification
- name: Verify Git
  ansible.builtin.command: git --version
  register: verify_git
  environment:
    PATH: "/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:{{ user_home }}/.cargo/bin:{{ ansible_facts['env'].PATH }}"
  changed_when: false
  failed_when: verify_git.rc != 0

- name: Verify Git subtree (Linux - part of git package)
  ansible.builtin.command: git subtree --help
  register: verify_git_subtree
  changed_when: false
  failed_when: verify_git_subtree.rc != 0
  when: ansible_facts['distribution'] == 'Ubuntu'

- name: Verify Git subtree (macOS - skip, not in Homebrew git)
  ansible.builtin.set_fact:
    verify_git_subtree:
      stdout: "git subtree not included in Homebrew git (install separately if needed)"
      rc: 0
  when: ansible_facts['distribution'] == 'MacOSX'

- name: Verify Git LFS filter installed
  ansible.builtin.command: git lfs env
  register: verify_git_lfs
  environment:
    PATH: "/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:{{ user_home }}/.cargo/bin:{{ ansible_facts['env'].PATH }}"
  changed_when: false
  failed_when: verify_git_lfs.rc != 0
  become: false
  become_user: "{{ actual_user }}"

# Python tools
- name: Verify UV
  ansible.builtin.command: "{{ user_home }}/.cargo/bin/uv --version"
  register: verify_uv
  environment:
    PATH: "/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:{{ user_home }}/.cargo/bin:{{ ansible_facts['env'].PATH }}"
  changed_when: false
  failed_when: verify_uv.rc != 0
  become: false
  become_user: "{{ actual_user }}"

- name: Verify UV can list Python versions
  ansible.builtin.command: "{{ user_home }}/.cargo/bin/uv python list"
  register: verify_uv_python
  environment:
    PATH: "/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:{{ user_home }}/.cargo/bin:{{ ansible_facts['env'].PATH }}"
  changed_when: false
  failed_when: verify_uv_python.rc != 0
  become: false
  become_user: "{{ actual_user }}"

# Cloud tools
- name: Verify AWS CLI
  ansible.builtin.command: aws --version
  register: verify_aws
  environment:
    PATH: "/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:{{ user_home }}/.cargo/bin:{{ ansible_facts['env'].PATH }}"
  changed_when: false
  failed_when: verify_aws.rc != 0

- name: Verify yq
  ansible.builtin.command: yq --version
  register: verify_yq
  environment:
    PATH: "/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:{{ user_home }}/.cargo/bin:{{ ansible_facts['env'].PATH }}"
  changed_when: false
  failed_when: verify_yq.rc != 0

# Config file validation
- name: Verify DNF performance config (Fedora)
  ansible.builtin.stat:
    path: /etc/dnf/dnf.conf.d/99-performance.conf
  register: verify_dnf_conf
  failed_when: not verify_dnf_conf.stat.exists
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - use_fastestmirror | default(true)

- name: Verify APT performance config (Ubuntu)
  ansible.builtin.stat:
    path: /etc/apt/apt.conf.d/99-performance
  register: verify_apt_conf
  failed_when: not verify_apt_conf.stat.exists
  when:
    - ansible_facts['distribution'] == 'Ubuntu'
    - use_fastestmirror | default(true)

- name: Display base tools verification (Linux)
  ansible.builtin.debug:
    msg: |
      ✅ Base Developer Tools Verified:
      - Docker: {{ verify_docker.stdout }} (service enabled ✅)
      - Docker group: User added (logout required for shell access)
      - kubectl: {{ verify_kubectl.stdout | regex_search('v[0-9.]+') }}
      - Helm: {{ verify_helm.stdout }}
      - Terraform: {{ verify_terraform.stdout_lines[0] }}
      - Git: {{ verify_git.stdout }}
      - Git subtree: ✅
      - Git LFS: ✅ Filters installed
      - UV: {{ verify_uv.stdout }} (can list Python versions ✅)
      - AWS CLI: {{ verify_aws.stdout }}
      - yq: {{ verify_yq.stdout }}
  when: ansible_facts['distribution'] in ['Fedora', 'Ubuntu']

- name: Display base tools verification (macOS)
  ansible.builtin.debug:
    msg: |
      ✅ Base Developer Tools Verified:
      - Docker Desktop: Installed (launch manually for CLI access)
      - kubectl: {{ verify_kubectl.stdout | regex_search('v[0-9.]+') }}
      - Helm: {{ verify_helm.stdout }}
      - Terraform: {{ verify_terraform.stdout_lines[0] }}
      - Git: {{ verify_git.stdout }}
      - Git subtree: ✅
      - Git LFS: ✅ Filters installed
      - UV: {{ verify_uv.stdout }} (can list Python versions ✅)
      - AWS CLI: {{ verify_aws.stdout }}
      - yq: {{ verify_yq.stdout }}
  when: ansible_facts['distribution'] == 'MacOSX'
