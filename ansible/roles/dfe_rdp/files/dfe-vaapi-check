#!/bin/bash
# dfe-vaapi-check - Auto-enable GRD hardware encoding when VA-API H.264 becomes available
# Deployed by dfe-developer ansible role
# Runs on system boot via systemd service

set -euo pipefail

OVERRIDE_DIR="/etc/systemd/user/gnome-remote-desktop.service.d"
OVERRIDE_FILE="${OVERRIDE_DIR}/vaapi.conf"
MARKER_FILE="/var/lib/dfe-developer/vaapi-enabled"

# Check if VA-API H.264 encoding is available
check_vaapi_h264() {
    if ! command -v vainfo &>/dev/null; then
        return 1
    fi
    vainfo --display drm 2>&1 | grep -q "VAProfileH264High.*VAEntrypointEncSlice"
}

# Check if override is already configured
is_already_configured() {
    [[ -f "$OVERRIDE_FILE" ]] && grep -q "GRD_DEBUG=vkva-renderer" "$OVERRIDE_FILE" 2>/dev/null
}

# Enable hardware encoding
enable_hardware_encoding() {
    mkdir -p "$OVERRIDE_DIR"
    cat > "$OVERRIDE_FILE" << 'EOF'
# Auto-enabled by dfe-vaapi-check when VA-API H.264 encoding detected
# See: https://gitlab.gnome.org/GNOME/gnome-remote-desktop/-/merge_requests/294
[Service]
Environment="GRD_DEBUG=vkva-renderer"
EOF
    chmod 644 "$OVERRIDE_FILE"

    # Create marker directory and file
    mkdir -p "$(dirname "$MARKER_FILE")"
    date -Iseconds > "$MARKER_FILE"

    # Reload systemd to pick up changes
    systemctl daemon-reload 2>/dev/null || true

    return 0
}

main() {
    # Already configured - nothing to do (idempotent)
    if is_already_configured; then
        exit 0
    fi

    # Check if VA-API H.264 is available
    if check_vaapi_h264; then
        enable_hardware_encoding
        logger -t dfe-developer "VA-API H.264 encoding detected - enabled GRD hardware encoding (GRD_DEBUG=vkva-renderer)"

        # Restart grd if running to apply changes
        if systemctl --user is-active gnome-remote-desktop.service &>/dev/null; then
            systemctl --user restart gnome-remote-desktop.service 2>/dev/null || true
        fi
    fi
}

main "$@"
