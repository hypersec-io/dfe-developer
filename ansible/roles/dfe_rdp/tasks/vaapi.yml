---
# VA-API Hardware Encoding Detection and Auto-Enablement
# Two-pronged approach:
# 1. Ansible-time: Check and enable if available now
# 2. Runtime: Deploy service that auto-enables when VA-API becomes available later

# ============================================================================
# INSTALL VAINFO FOR VA-API DETECTION
# ============================================================================

- name: Check if vainfo is available
  ansible.builtin.command:
    cmd: which vainfo
  register: vainfo_check
  failed_when: false
  changed_when: false
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - dfe_has_gnome

- name: Install libva-utils for VA-API detection (Fedora)
  ansible.builtin.dnf:
    name: libva-utils
    state: present
  when:
    - ansible_facts['distribution'] == 'Fedora'
    - dfe_has_gnome
    - vainfo_check.rc != 0

- name: Install vainfo for VA-API detection (Ubuntu)
  ansible.builtin.apt:
    name: vainfo
    state: present
  when:
    - ansible_facts['distribution'] == 'Ubuntu'
    - dfe_has_gnome
    - vainfo_check.rc != 0

# ============================================================================
# DEPLOY AUTO-DETECTION SERVICE (runs on every boot)
# ============================================================================

- name: Deploy VA-API auto-detection script
  ansible.builtin.copy:
    src: dfe-vaapi-check
    dest: /usr/local/bin/dfe-vaapi-check
    mode: '0755'
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - dfe_has_gnome

- name: Deploy VA-API auto-detection systemd service
  ansible.builtin.copy:
    src: dfe-vaapi-check.service
    dest: /etc/systemd/system/dfe-vaapi-check.service
    mode: '0644'
  register: vaapi_service_deployed
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - dfe_has_gnome

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - dfe_has_gnome
    - vaapi_service_deployed.changed | default(false)

- name: Enable VA-API auto-detection service
  ansible.builtin.systemd:
    name: dfe-vaapi-check.service
    enabled: true
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - dfe_has_gnome

# ============================================================================
# ANSIBLE-TIME CHECK: Enable now if VA-API already available
# ============================================================================

- name: Check VA-API H.264 encoding support
  ansible.builtin.shell:
    cmd: vainfo --display drm 2>&1 | grep -q "VAProfileH264High.*VAEntrypointEncSlice"
  register: vaapi_h264_check
  failed_when: false
  changed_when: false
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - dfe_has_gnome

- name: Set VA-API H.264 availability fact
  ansible.builtin.set_fact:
    dfe_vaapi_h264_available: "{{ vaapi_h264_check.rc == 0 }}"
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - dfe_has_gnome

- name: Run VA-API check script now (enables if available)
  ansible.builtin.command:
    cmd: /usr/local/bin/dfe-vaapi-check
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - dfe_has_gnome
  changed_when: false

# ============================================================================
# DISPLAY STATUS
# ============================================================================

- name: Display VA-API status
  ansible.builtin.debug:
    msg: |
      VA-API H.264 encoding: {{ 'AVAILABLE' if dfe_vaapi_h264_available | default(false) else 'NOT AVAILABLE (CPU fallback)' }}
      Auto-detection service: ENABLED (will auto-enable hardware encoding when VA-API becomes available)
  when:
    - ansible_facts['distribution'] in ['Fedora', 'Ubuntu']
    - dfe_has_gnome
