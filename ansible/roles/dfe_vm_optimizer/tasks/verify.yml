---
# Verification - VM optimizer (functional checks)

- name: Verify virtualization detection
  ansible.builtin.debug:
    msg: "Virtualization: {{ ansible_virtualization_type }} (role: {{ ansible_virtualization_role }})"

- name: Skip verification if not a VM
  ansible.builtin.meta: end_play
  when: ansible_virtualization_role != 'guest'

# Check sysctl parameters were applied
- name: Verify vm.swappiness setting
  ansible.builtin.command: sysctl -n vm.swappiness
  register: verify_swappiness
  changed_when: false
  failed_when: verify_swappiness.stdout != '10'

- name: Verify BBR congestion control
  ansible.builtin.command: sysctl -n net.ipv4.tcp_congestion_control
  register: verify_bbr
  changed_when: false
  failed_when: verify_bbr.stdout != 'bbr'

# Check VM-specific services
- name: Verify QEMU guest agent (KVM)
  ansible.builtin.systemd:
    name: qemu-guest-agent.service
  register: verify_qemu
  failed_when: verify_qemu.status.ActiveState != 'active'
  when:
    - ansible_virtualization_type in ['kvm', 'qemu']
    - ansible_distribution in ['Fedora', 'Ubuntu']

- name: Verify VMware tools (VMware)
  ansible.builtin.systemd:
    name: vmtoolsd.service
  register: verify_vmtools
  failed_when: verify_vmtools.status.ActiveState != 'active'
  when:
    - ansible_virtualization_type == 'VMware'
    - ansible_distribution in ['Fedora', 'Ubuntu']

# Check journal size limit
- name: Verify journal size limit
  ansible.builtin.command: journalctl --disk-usage
  register: verify_journal
  changed_when: false

# Config file validation
- name: Verify sysctl config file exists
  ansible.builtin.stat:
    path: /etc/sysctl.d/98-vm-optimizer.conf
  register: verify_sysctl_conf
  failed_when: not verify_sysctl_conf.stat.exists

- name: Verify journal config file exists
  ansible.builtin.stat:
    path: /etc/systemd/journald.conf.d/vm-optimizer.conf
  register: verify_journal_conf
  failed_when: not verify_journal_conf.stat.exists

- name: Display VM optimizer verification
  ansible.builtin.debug:
    msg: |
      ✅ VM Optimizer Verified:
      - VM Type: {{ ansible_virtualization_type }}
      - vm.swappiness: {{ verify_swappiness.stdout }} (target: 10) ✅
      - BBR: {{ verify_bbr.stdout }} ✅
      - Guest tools: {{ 'qemu-guest-agent active' if ansible_virtualization_type in ['kvm', 'qemu'] else 'vmtoolsd active' if ansible_virtualization_type == 'VMware' else 'N/A' }}
      - Journal size: {{ verify_journal.stdout }}
